System.register([],function(e,t){"use strict";return{execute:function(){const t=e("E",{GAME_START:"game:start",GAME_PAUSE:"game:pause",GAME_RESUME:"game:resume",GAME_SAVE:"game:save",GAME_LOAD:"game:load",TURN_START:"turn:start",TURN_END:"turn:end",APPROVAL_CHANGE:"politics:approval_change",POLICY_PROPOSED:"politics:policy_proposed",UI_UPDATE:"ui:update",UI_NOTIFICATION:"ui:notification",UI_ERROR:"ui:error"}),i=e("e",new class{constructor(){this.listeners=new Map,this.eventQueue=[],this.isProcessing=!1}on(e,t,i=null){this.listeners.has(e)||this.listeners.set(e,[]);const s={callback:t,context:i};return this.listeners.get(e).push(s),()=>this.off(e,t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e),s=i.findIndex(e=>e.callback===t);-1!==s&&i.splice(s,1),0===i.length&&this.listeners.delete(e)}emit(e,t={}){if(!this.listeners.has(e))return;const i={type:e,data:t,timestamp:Date.now()};[...this.listeners.get(e)].forEach(t=>{try{t.context?t.callback.call(t.context,i):t.callback(i)}catch(s){console.error(`Error in event listener for ${e}:`,s)}})}queue(e,t={}){this.eventQueue.push({type:e,data:t,timestamp:Date.now()})}processQueue(){if(!this.isProcessing){for(this.isProcessing=!0;this.eventQueue.length>0;){const e=this.eventQueue.shift();this.emit(e.type,e.data)}this.isProcessing=!1}}clear(){this.listeners.clear(),this.eventQueue=[],this.isProcessing=!1}getStats(){return{eventTypes:this.listeners.size,totalListeners:Array.from(this.listeners.values()).reduce((e,t)=>e+t.length,0),queuedEvents:this.eventQueue.length,isProcessing:this.isProcessing}}}),s=new class{constructor(){this.storageKey="sp_sim_saves",this.autoSaveKey="sp_sim_autosave",this.maxSaves=10,this.compressionEnabled=!0}saveGame(e,t=null){try{const i=this.prepareSaveData(e,t),s=this.getAllSaves();return s.unshift(i),s.length>this.maxSaves&&s.splice(this.maxSaves),localStorage.setItem(this.storageKey,JSON.stringify(s)),console.log(`Game saved successfully: ${i.name}`),!0}catch(i){return console.error("Failed to save game:",i),!1}}loadGame(e){try{const t=this.getAllSaves().find(t=>t.id===e);if(!t)return console.error(`Save not found: ${e}`),null;const i=this.decompressData(t.data);return console.log(`Game loaded successfully: ${t.name}`),i}catch(t){return console.error("Failed to load game:",t),null}}autoSave(e){try{const t=this.prepareSaveData(e,"Auto Save");return localStorage.setItem(this.autoSaveKey,JSON.stringify(t)),!0}catch(t){return console.error("Auto-save failed:",t),!1}}loadAutoSave(){try{const e=localStorage.getItem(this.autoSaveKey);if(!e)return null;const t=JSON.parse(e);return this.decompressData(t.data)}catch(e){return console.error("Failed to load auto-save:",e),null}}getAllSaves(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to retrieve saves:",e),[]}}deleteSave(e){try{const t=this.getAllSaves().filter(t=>t.id!==e);return localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log(`Save deleted: ${e}`),!0}catch(t){return console.error("Failed to delete save:",t),!1}}clearAllSaves(){try{return localStorage.removeItem(this.storageKey),localStorage.removeItem(this.autoSaveKey),console.log("All saves cleared"),!0}catch(e){return console.error("Failed to clear saves:",e),!1}}exportSave(e){try{const t=this.getAllSaves().find(t=>t.id===e);if(!t)return console.error(`Save not found for export: ${e}`),!1;const i=JSON.stringify(t,null,2),s=new Blob([i],{type:"application/json"}),a=URL.createObjectURL(s),n=document.createElement("a");return n.href=a,n.download=`sp_sim_save_${t.name.replace(/\s+/g,"_")}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),!0}catch(t){return console.error("Failed to export save:",t),!1}}async importSave(e){try{const t=await e.text(),i=JSON.parse(t);if(!this.validateSaveData(i))return console.error("Invalid save file format"),!1;i.id=this.generateSaveId(),i.imported=!0;const s=this.getAllSaves();return s.unshift(i),localStorage.setItem(this.storageKey,JSON.stringify(s)),console.log(`Save imported successfully: ${i.name}`),!0}catch(t){return console.error("Failed to import save:",t),!1}}getStorageStats(){try{const e=this.getAllSaves(),t=localStorage.getItem(this.autoSaveKey),i=new Blob([localStorage.getItem(this.storageKey)||""]).size,s=i+new Blob([t||""]).size;return{saveCount:e.length,totalSizeBytes:s,totalSizeKB:Math.round(s/1024),hasAutoSave:!!t,maxSaves:this.maxSaves}}catch(e){return console.error("Failed to get storage stats:",e),null}}prepareSaveData(e,t){const i=new Date,s=t||`Save ${i.toLocaleDateString()} ${i.toLocaleTimeString()}`;return{id:this.generateSaveId(),name:s,timestamp:i.toISOString(),version:e.version||"1.0.0",gameTime:e.time||{},data:this.compressData(e)}}generateSaveId(){return`save_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}compressData(e){if(!this.compressionEnabled)return e;try{return JSON.stringify(e)}catch(t){return console.error("Compression failed:",t),e}}decompressData(e){if(!this.compressionEnabled)return e;try{return"string"==typeof e?JSON.parse(e):e}catch(t){return console.error("Decompression failed:",t),e}}validateSaveData(e){return e&&"object"==typeof e&&e.id&&e.name&&e.timestamp&&e.data}},a=e("a",new class{constructor(){this.metrics={gdp:1e12,gdpGrowth:2.1,unemployment:6,inflation:2.4,interestRate:3.5,consumerSpending:.65,governmentSpending:.2,investment:.18,netExports:-.03,productivity:1,confidence:75},this.sectors={agriculture:{share:.05,growth:1.2,volatility:.15},manufacturing:{share:.25,growth:2.8,volatility:.1},services:{share:.7,growth:2,volatility:.05}},this.cycle={phase:"expansion",duration:0,intensity:.5},this.shocks=[],this.policies=[],this.setupEventListeners()}setupEventListeners(){i.on(t.TURN_END,()=>{this.updateEconomy()}),i.on("policy:implemented",e=>{this.applyPolicy(e.data.policy)}),i.on("economic:shock",e=>{this.applyShock(e.data.shock)})}updateEconomy(){this.updateBusinessCycle(),this.updateSectors(),this.updateGDP(),this.updateUnemployment(),this.updateInflation(),this.updateConfidence(),this.applyActivePolicies(),this.checkEconomicEvents(),i.emit("economic:update",{metrics:{...this.metrics},sectors:{...this.sectors},cycle:{...this.cycle}})}processEconomicTurn(e,t={},i={},s={},a={}){const n={...this.metrics};this.updateBusinessCycle(),this.updateSectorInteractions(),this.updateGDPWithEffects(t,i,s,a),this.updateUnemploymentWithEffects(t,i,s),this.updateInflationWithEffects(t,i,s),this.updateConfidenceWithEffects(a),this.updateProductivity(e),this.updateInterestRates(e),this.updateConsumerSpending(e),this.updateGovernmentFinances(e),this.applyActivePolicies(),this.checkEconomicEvents();const o={gdpGrowthDelta:this.metrics.gdpGrowth-n.gdpGrowth,unemploymentDelta:this.metrics.unemployment-n.unemployment,inflationDelta:this.metrics.inflation-n.inflation,confidenceDelta:this.metrics.confidence-n.confidence};return{...this.metrics,sectors:{...this.sectors},cycle:{...this.cycle},deltas:o,previousState:n,appliedEffects:{policyEffects:t,externalPressures:i,cycleEffects:s,confidenceEffects:a}}}updateBusinessCycle(){switch(this.cycle.duration+=1,this.cycle.phase){case"expansion":this.cycle.duration>104||this.metrics.inflation>4.5?(this.cycle.phase="peak",this.cycle.duration=0,this.cycle.intensity=Math.min(1,this.cycle.intensity+.1)):this.cycle.intensity=Math.min(1,this.cycle.intensity+.02);break;case"peak":(this.cycle.duration>8||this.metrics.unemployment>7.5)&&(this.cycle.phase="recession",this.cycle.duration=0,this.cycle.intensity=Math.max(.1,this.cycle.intensity-.1));break;case"recession":this.cycle.duration>52||this.metrics.gdpGrowth>0?(this.cycle.phase="trough",this.cycle.duration=0,this.cycle.intensity=Math.max(.1,this.cycle.intensity-.02)):this.cycle.intensity=Math.max(.1,this.cycle.intensity-.03);break;case"trough":(this.cycle.duration>12||this.metrics.confidence>60)&&(this.cycle.phase="expansion",this.cycle.duration=0,this.cycle.intensity=Math.min(1,this.cycle.intensity+.05));break;default:this.cycle.phase="expansion",this.cycle.duration=0}}updateSectors(){Object.keys(this.sectors).forEach(e=>{const t=this.sectors[e];let{growth:i}=t;const s=this.getCycleEffect();i*=s,i+=(Math.random()-.5)*t.volatility*2,t.currentGrowth=i,t.cycleEffect=s})}updateGDP(){let e=0;Object.keys(this.sectors).forEach(t=>{const i=this.sectors[t];e+=i.share*(i.currentGrowth||i.growth)});const t=.5*(this.metrics.productivity-1);e+=t;const i=(this.metrics.confidence-50)/100;e+=i,this.metrics.gdpGrowth=this.smoothUpdate(this.metrics.gdpGrowth,e,.3);const s=this.metrics.gdpGrowth/52/100;this.metrics.gdp*=1+s}updateGDPWithEffects(e,t,i,s){let a=0;Object.keys(this.sectors).forEach(e=>{const t=this.sectors[e];a+=t.share*(t.currentGrowth||t.growth)});const n=.5*(this.metrics.productivity-1);if(a+=n,e.gdpGrowthEffect&&(a+=e.gdpGrowthEffect),t.globalGrowthEffect&&(a+=t.globalGrowthEffect),t.tradeEffect&&(a+=t.tradeEffect),i.gdpEffect&&(a+=i.gdpEffect),s.level){const e=(s.level-50)/100*.5;a+=e}this.metrics.gdpGrowth=this.smoothUpdate(this.metrics.gdpGrowth,a,.3);const o=this.metrics.gdpGrowth/52/100;this.metrics.gdp*=1+o}updateUnemployment(){const e=6-.4*(this.metrics.gdpGrowth-2);let t=0;switch(this.cycle.phase){case"recession":t=.5;break;case"trough":t=.2;break;case"expansion":t=-.3;break;case"peak":t=-.1;break;default:t=0}const i=Math.max(3,Math.min(12,e+t));this.metrics.unemployment=this.smoothUpdate(this.metrics.unemployment,i,.2)}updateUnemploymentWithEffects(e,t,i){let s=6-.4*(this.metrics.gdpGrowth-2);e.unemploymentEffect&&(s+=e.unemploymentEffect),t.globalGrowthEffect&&(s-=.5*t.globalGrowthEffect),i.unemploymentEffect&&(s+=i.unemploymentEffect),s=(s+(this.calculateSectorUnemployment("manufacturing")+this.calculateSectorUnemployment("services"))/2)/2,this.metrics.unemployment=this.smoothUpdate(this.metrics.unemployment,s,.15),this.metrics.unemployment=Math.max(2,Math.min(25,this.metrics.unemployment))}updateInflation(){const e=2+Math.max(0,.3*(7-this.metrics.unemployment))+.8*this.cycle.intensity+(this.metrics.interestRate<2?.5:-.2),t=.4*(Math.random()-.5),i=Math.max(0,e+t);this.metrics.inflation=this.smoothUpdate(this.metrics.inflation,i,.25)}updateInflationWithEffects(e,t,i){let s=2.4;s+=.1*(6-this.metrics.unemployment),this.metrics.gdpGrowth>3&&(s+=.2*(this.metrics.gdpGrowth-3)),e.inflationEffect&&(s+=e.inflationEffect),t.commodityPriceEffect&&(s-=t.commodityPriceEffect),i.inflationEffect&&(s+=i.inflationEffect),s+=this.calculateSupplyChainInflation(),s+=-.1*(this.metrics.interestRate-3.5),this.metrics.inflation=this.smoothUpdate(this.metrics.inflation,s,.2),this.metrics.inflation=Math.max(-2,Math.min(15,this.metrics.inflation))}updateConfidence(){let e=0;switch(this.metrics.gdpGrowth>3?e+=2:this.metrics.gdpGrowth<0&&(e-=3),this.metrics.unemployment<5?e+=1:this.metrics.unemployment>8&&(e-=2),this.metrics.inflation>4?e-=2:this.metrics.inflation<1&&(e-=1),this.cycle.phase){case"expansion":e+=1;break;case"recession":e-=2;break;case"trough":e+=.5}e+=2*(Math.random()-.5),this.metrics.confidence=Math.max(0,Math.min(100,this.metrics.confidence+e))}updateConfidenceWithEffects(e){let t=50;switch(this.metrics.gdpGrowth>2&&(t+=8*(this.metrics.gdpGrowth-2)),this.metrics.gdpGrowth<0&&(t+=15*this.metrics.gdpGrowth),this.metrics.unemployment<5&&(t+=3*(5-this.metrics.unemployment)),this.metrics.unemployment>8&&(t-=4*(this.metrics.unemployment-8)),this.metrics.inflation>4&&(t-=3*(this.metrics.inflation-4)),this.metrics.inflation<0&&(t-=5*Math.abs(this.metrics.inflation)),e.level&&(t=(t+e.level)/2),this.cycle.phase){case"expansion":t+=5;break;case"peak":t+=2;break;case"contraction":t-=8;break;case"trough":t-=5}this.metrics.confidence=this.smoothUpdate(this.metrics.confidence,t,.25),this.metrics.confidence=Math.max(0,Math.min(100,this.metrics.confidence))}applyPolicy(e){switch(this.policies.push({...e,duration:e.duration||12,implementedWeek:0}),e.type){case"fiscal_stimulus":this.metrics.confidence+=5,this.metrics.governmentSpending+=e.amount||.02;break;case"tax_cut":this.metrics.confidence+=3,this.metrics.consumerSpending+=e.amount||.01;break;case"tax_increase":this.metrics.confidence-=4,this.metrics.consumerSpending-=e.amount||.015;break;case"interest_rate_change":this.metrics.interestRate+=e.change||0;break;case"infrastructure_investment":this.metrics.productivity+=e.amount||.05,this.sectors.manufacturing.growth+=e.amount||.5;break;case"education_investment":this.metrics.productivity+=e.amount||.03,this.sectors.services.growth+=e.amount||.3;break;case"healthcare_investment":this.metrics.productivity+=e.amount||.02,this.metrics.confidence+=3;break;case"green_energy_investment":this.sectors.manufacturing.growth+=e.amount||.4,this.metrics.productivity+=e.amount||.04;break;case"trade_promotion":this.metrics.netExports+=e.amount||.01,this.sectors.manufacturing.growth+=e.amount||.3;break;case"regulation_increase":this.sectors.services.growth-=e.amount||.2,this.metrics.confidence-=2;break;case"regulation_decrease":this.sectors.services.growth+=e.amount||.3,this.metrics.confidence+=2;break;case"agricultural_subsidies":this.sectors.agriculture.growth+=e.amount||.5,this.metrics.governmentSpending+=e.amount||.005;break;case"minimum_wage_increase":this.metrics.consumerSpending+=e.amount||.008,this.metrics.confidence+=2,this.metrics.inflation+=e.amount||.3}i.emit("economic:policy_applied",{policy:e,newMetrics:{...this.metrics}})}applyActivePolicies(){this.policies=this.policies.filter(e=>(e.implementedWeek+=1,e.ongoingEffects&&Object.keys(e.ongoingEffects).forEach(t=>{void 0!==this.metrics[t]&&(this.metrics[t]+=e.ongoingEffects[t])}),e.implementedWeek<e.duration))}applyShock(e){switch(this.shocks.push(e),e.type){case"oil_price_spike":this.metrics.inflation+=e.magnitude||1,this.metrics.confidence-=5*e.magnitude||10;break;case"financial_crisis":this.metrics.confidence-=20*e.magnitude||30,this.cycle.phase="recession",this.cycle.duration=0;break;case"trade_war":this.metrics.netExports-=e.magnitude||.02,this.sectors.manufacturing.growth-=e.magnitude||1;break;case"pandemic":this.metrics.gdpGrowth-=e.magnitude||5,this.metrics.unemployment+=e.magnitude||3,this.sectors.services.growth-=e.magnitude||3;break;case"supply_chain_disruption":this.sectors.manufacturing.growth-=e.magnitude,this.sectors.services.growth-=.5*e.magnitude,this.metrics.inflation+=.3*e.magnitude;break;case"commodity_price_spike":this.metrics.inflation+=e.magnitude,this.sectors.agriculture.growth-=.8*e.magnitude,this.metrics.confidence-=3*e.magnitude;break;case"currency_fluctuation":this.metrics.netExports+=(Math.random()-.5)*e.magnitude*.02,this.metrics.inflation+=.2*e.magnitude;break;case"tech_innovation":this.metrics.productivity+=.1*e.magnitude,this.sectors.services.growth+=e.magnitude,this.metrics.confidence+=5*e.magnitude;break;case"natural_disaster":this.metrics.gdpGrowth-=e.magnitude,this.sectors.agriculture.growth-=1.5*e.magnitude,this.metrics.confidence-=8*e.magnitude;break;case"geopolitical_tension":this.metrics.confidence-=6*e.magnitude,this.metrics.netExports-=.01*e.magnitude,this.metrics.investment-=.01*e.magnitude}i.emit("economic:shock_applied",{shock:e,newMetrics:{...this.metrics}})}checkEconomicEvents(){const e=[];if(this.metrics.inflation>4&&Math.random()<.1&&e.push({type:"high_inflation_warning",message:`Inflation has reached ${this.metrics.inflation.toFixed(1)}%. Consider monetary policy adjustments.`,severity:"warning"}),this.metrics.gdpGrowth<-1&&"recession"!==this.cycle.phase&&e.push({type:"recession_warning",message:"Economic indicators suggest a recession. GDP growth is negative.",severity:"danger"}),this.metrics.unemployment<4&&Math.random()<.05&&e.push({type:"low_unemployment",message:`Unemployment has dropped to ${this.metrics.unemployment.toFixed(1)}%. Conditions are favorable.`,severity:"success"}),this.metrics.gdpGrowth>4&&this.metrics.unemployment<5&&Math.random()<.08&&e.push({type:"economic_boom",message:`Economic boom detected! GDP growth at ${this.metrics.gdpGrowth.toFixed(1)}% with low unemployment.`,severity:"success"}),this.metrics.inflation<.5&&Math.random()<.06&&e.push({type:"deflation_risk",message:`Deflation risk: Inflation is only ${this.metrics.inflation.toFixed(1)}%. Consider stimulus measures.`,severity:"warning"}),this.metrics.inflation>3.5&&this.metrics.unemployment>7&&this.metrics.gdpGrowth<1&&Math.random()<.1&&e.push({type:"stagflation",message:"Stagflation detected: High inflation and unemployment with low growth. Difficult policy choices ahead.",severity:"danger"}),this.metrics.interestRate<=.5&&Math.random()<.05&&e.push({type:"zero_interest_rate",message:"Interest rates near zero. Traditional monetary policy effectiveness limited.",severity:"warning"}),Object.keys(this.sectors).forEach(t=>{const i=this.sectors[t];i.currentGrowth>5&&Math.random()<.04&&e.push({type:"sector_boom",message:`${t.charAt(0).toUpperCase()+t.slice(1)} sector experiencing rapid growth at ${i.currentGrowth.toFixed(1)}%.`,severity:"success"}),i.currentGrowth<-2&&Math.random()<.06&&e.push({type:"sector_decline",message:`${t.charAt(0).toUpperCase()+t.slice(1)} sector declining at ${i.currentGrowth.toFixed(1)}%. May need targeted support.`,severity:"warning"})}),Math.random()<.02){const t=this.generateRandomShock();t&&(e.push(t),this.applyShock(t))}this.metrics.confidence>85&&Math.random()<.03&&e.push({type:"high_confidence",message:`Consumer confidence at ${this.metrics.confidence.toFixed(0)}%. Strong economic sentiment boosting spending.`,severity:"success"}),this.metrics.confidence<30&&Math.random()<.05&&e.push({type:"confidence_crisis",message:`Consumer confidence plummeted to ${this.metrics.confidence.toFixed(0)}%. Economic uncertainty affecting all sectors.`,severity:"danger"}),e.forEach(e=>{i.emit("economic:event",e)})}generateRandomShock(){const e=[{type:"supply_chain_disruption",message:"Global supply chain disruption affecting manufacturing and services.",severity:"warning",magnitude:.5+1*Math.random()},{type:"commodity_price_spike",message:"Commodity prices surge affecting production costs and inflation.",severity:"warning",magnitude:.3+.7*Math.random()},{type:"currency_fluctuation",message:"Major currency fluctuation impacting trade balance and imports.",severity:"info",magnitude:.2+.5*Math.random()},{type:"tech_innovation",message:"Technological breakthrough boosting productivity in key sectors.",severity:"success",magnitude:.3+.4*Math.random()},{type:"natural_disaster",message:"Natural disaster affecting regional economic activity.",severity:"danger",magnitude:.4+.8*Math.random()},{type:"geopolitical_tension",message:"Geopolitical tensions affecting trade and investor confidence.",severity:"warning",magnitude:.3+.6*Math.random()}];return e[Math.floor(Math.random()*e.length)]}getCycleEffect(){switch(this.cycle.phase){case"expansion":return 1+.2*this.cycle.intensity;case"peak":return 1.1;case"recession":return.8-.3*this.cycle.intensity;case"trough":return.7;default:return 1}}smoothUpdate(e,t,i){return e+(t-e)*i}getEconomicState(){return{metrics:{...this.metrics},sectors:{...this.sectors},cycle:{...this.cycle},activePolicies:this.policies.length,activeShocks:this.shocks.length}}getForecast(e=12){const t={gdpGrowth:[],unemployment:[],inflation:[]};let i=this.metrics.gdpGrowth,s=this.metrics.unemployment,a=this.metrics.inflation;for(let n=1;n<=e;n+=1)i=this.smoothUpdate(i,2.1,.05),s=this.smoothUpdate(s,6,.03),a=this.smoothUpdate(a,2,.04),t.gdpGrowth.push(Number(i.toFixed(2))),t.unemployment.push(Number(s.toFixed(1))),t.inflation.push(Number(a.toFixed(1)));return t}updateProductivity(e){let t=.001;if(e.policies){const i=e.policies.active?.filter(e=>"education"===e.category)||[],s=e.policies.active?.filter(e=>"infrastructure"===e.category)||[];t+=5e-4*i.length,t+=3e-4*s.length}this.metrics.unemployment>8&&(t-=1e-4*(this.metrics.unemployment-8)),t+=this.metrics.gdpGrowth>3?2e-4:0,this.metrics.productivity*=1+t,this.metrics.productivity=Math.max(.5,Math.min(3,this.metrics.productivity))}updateInterestRates(e){let t=this.metrics.inflation-2.4+2+.5*(this.metrics.gdpGrowth-2.5);e.politics&&e.politics.approval<40&&(t-=.5),this.metrics.interestRate=this.smoothUpdate(this.metrics.interestRate,t,.1),this.metrics.interestRate=Math.max(0,Math.min(15,this.metrics.interestRate))}updateConsumerSpending(e){let t=.65;t+=.01*-(this.metrics.unemployment-6),t+=(this.metrics.confidence-50)/100*.05,t+=.01*-(this.metrics.interestRate-3.5),e.demographics&&e.demographics.income&&(t+=.1*(e.demographics.income.middle/100-.45)),this.metrics.consumerSpending=this.smoothUpdate(this.metrics.consumerSpending,t,.1),this.metrics.consumerSpending=Math.max(.4,Math.min(.8,this.metrics.consumerSpending))}updateGovernmentFinances(e){let t=.001*this.metrics.gdp;e.politics&&(t*=.85+(e.politics.approval-50)/1e3),this.metrics.gdpGrowth<0&&(t*=1+this.metrics.gdpGrowth/100),e.economy.government||(e.economy.government={revenue:0,spending:0,debt:1e12,deficit:0}),e.economy.government.revenue=t;const i=this.metrics.gdp*this.metrics.governmentSpending/52;e.economy.government.spending=i,e.economy.government.deficit=e.economy.government.spending-e.economy.government.revenue,e.economy.government.debt+=e.economy.government.deficit}updateSectorInteractions(){const e=this.sectors.manufacturing.currentGrowth||this.sectors.manufacturing.growth,t=this.sectors.services.currentGrowth||this.sectors.services.growth,i=this.sectors.agriculture.currentGrowth||this.sectors.agriculture.growth;e>2.5?this.sectors.services.growth+=.1:e<0&&(this.sectors.services.growth-=.05),t>2?this.sectors.manufacturing.growth+=.05:t<-1&&(this.sectors.manufacturing.growth-=.1),i<-2?(this.sectors.manufacturing.growth-=.03,this.sectors.services.growth-=.02):i>3&&(this.sectors.manufacturing.growth+=.02,this.sectors.services.growth+=.01);const s=this.calculateSupplyChainStress();s>.5&&Object.keys(this.sectors).forEach(e=>{this.sectors[e].growth-=.1*s}),this.updateLaborMobility()}calculateSectorUnemployment(e){const t=this.sectors[e];if(!t)return this.metrics.unemployment;let i=this.metrics.unemployment;const s=t.currentGrowth||t.growth;switch(s>2?i-=.3*(s-2):s<0&&(i+=.5*Math.abs(s)),e){case"manufacturing":"recession"===this.cycle.phase?i+=1.5:"expansion"===this.cycle.phase&&(i-=.8);break;case"services":i+=(this.metrics.confidence-50)/100*-.5;break;case"agriculture":i+=1*(Math.random()-.5)}return Math.max(1,Math.min(30,i))}calculateSupplyChainInflation(){let e=0;const t=this.sectors.manufacturing.currentGrowth||this.sectors.manufacturing.growth;return t<-1&&(e+=.1*Math.abs(t)),this.metrics.netExports<-.05&&(e+=.2),this.metrics.productivity<.95&&(e+=.5*(.95-this.metrics.productivity)),e+=.3*Math.random(),Math.random()<.02&&(e+=.1+.2*Math.random()),Math.max(0,Math.min(2,e))}calculateSupplyChainStress(){let e=0;const t=Object.values(this.sectors).map(e=>e.currentGrowth||e.growth);return e+=.1*this.calculateVariance(t),this.metrics.inflation>3.5&&(e+=.2*(this.metrics.inflation-3.5)),this.metrics.confidence<40&&(e+=.01*(40-this.metrics.confidence)),Math.max(0,Math.min(1,e))}updateLaborMobility(){const e={};Object.keys(this.sectors).forEach(t=>{const i=this.sectors[t];e[t]=i.currentGrowth||i.growth});const t=Object.entries(e).sort(([,e],[,t])=>t-e),i=t[0],s=t[t.length-1];if(i[1]-s[1]>2){const e=.001,t=Math.min(e,.1*this.sectors[s[0]].share);this.sectors[s[0]].share-=t,this.sectors[i[0]].share+=t,Object.keys(this.sectors).forEach(e=>{const t="agriculture"===e?.02:.05;this.sectors[e].share<t&&(this.sectors[e].share=t)});const a=Object.values(this.sectors).reduce((e,t)=>e+t.share,0);Object.keys(this.sectors).forEach(e=>{this.sectors[e].share/=a})}}calculateVariance(e){if(0===e.length)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length;return e.map(e=>(e-t)**2).reduce((e,t)=>e+t,0)/e.length}}),n=new class{constructor(){this.eventSystem=i,this.setupEventListeners()}setupEventListeners(){this.eventSystem.on(t.TURN_END,e=>{this.processPoliticalTurn(e.data.gameState)}),this.eventSystem.on("political:vote",e=>{this.processVote(e.data)}),this.eventSystem.on("political:crisis",e=>{this.handlePoliticalCrisis(e.data)})}processPoliticalTurn(e){this.updateApprovalRating(e),this.checkForPoliticalEvents(e),this.updateCoalitionDynamics(e),this.checkElectionCycle(e)}updateApprovalRating(e){let t=0;const{gdpGrowth:i}=e.economy,{unemployment:s}=e.economy,{inflation:a}=e.economy;i>3?t+=.5:i<1&&(t-=.3),s>8?t-=.8:s<4&&(t+=.4),a>4?t-=.5:a<2&&(t+=.2),t+=.5*(Math.random()-.5),e.politics.approval=Math.max(0,Math.min(100,e.politics.approval+t)),this.eventSystem.emit("political:approval_change",{change:t,newApproval:e.politics.approval,factors:{gdpGrowth:i,unemployment:s,inflation:a}})}checkForPoliticalEvents(e){Math.random()<.05&&this.triggerRandomPoliticalEvent(e)}triggerRandomPoliticalEvent(e){const t=[{title:"Opposition Challenge",description:"The opposition party has challenged your latest policy decisions.",approvalImpact:-2,type:"challenge"},{title:"Coalition Support",description:"Your coalition partners have publicly endorsed your leadership.",approvalImpact:1.5,type:"support"},{title:"Media Scrutiny",description:"Recent media coverage has put your administration under scrutiny.",approvalImpact:-1,type:"media"},{title:"Policy Success",description:"One of your key policies has shown positive early results.",approvalImpact:2,type:"policy"},{title:"International Praise",description:"International leaders have praised your diplomatic approach.",approvalImpact:1,type:"international"}],i=t[Math.floor(Math.random()*t.length)];e.politics.approval=Math.max(0,Math.min(100,e.politics.approval+i.approvalImpact)),e.events.recent.unshift({id:Date.now(),title:i.title,description:i.description,type:"political",severity:i.approvalImpact>0?"positive":"negative",week:e.time.week,year:e.time.year,timestamp:(new Date).toISOString()}),e.events.recent.length>10&&(e.events.recent=e.events.recent.slice(0,10)),this.eventSystem.emit("political:event",{event:i,gameState:e})}updateCoalitionDynamics(e){const{approval:t}=e.politics;e.politics.coalition.forEach(e=>{t>60?e.support=Math.min(100,e.support+.1):t<40&&(e.support=Math.max(0,e.support-.2))}),e.politics.opposition.forEach(e=>{t>60?e.support=Math.max(0,e.support-.1):t<40&&(e.support=Math.min(100,e.support+.15))})}checkElectionCycle(e){const t=e.time.week,i=e.time.year,s=e.politics.nextElection.year,a=e.politics.nextElection.week;(i>s||i===s&&t>=a)&&this.triggerElection(e)}triggerElection(e){const{approval:t}=e.politics,i=e.time.year,s=e.politics.nextElection.week;let a;a=t>=55?"victory":t>=45?"narrow_victory":t>=35?"coalition_required":"defeat",this.eventSystem.emit("political:election",{result:a,approval:t,gameState:e}),e.politics.nextElection={year:i+4,week:s||1}}createVote(e,t){const i={id:Date.now(),title:t.title,description:t.description,options:t.options||[{id:"support",text:"Support",approvalImpact:t.supportImpact||0},{id:"oppose",text:"Oppose",approvalImpact:t.opposeImpact||0},{id:"abstain",text:"Abstain",approvalImpact:-.5}],deadline:{week:e.time.week+2,year:e.time.year},status:"pending"};e.politics.nextVote=i,e.events.pending.push({id:i.id,type:"vote",title:`Vote: ${i.title}`,description:i.description,deadline:i.deadline}),this.eventSystem.emit("political:vote_scheduled",{vote:i,gameState:e})}processVote(e){const{gameState:t,voteId:i,choice:s}=e,a=t.politics.nextVote;if(!a||a.id!==i)return;const n=a.options.find(e=>e.id===s);if(n){let e;t.politics.approval=Math.max(0,Math.min(100,t.politics.approval+n.approvalImpact)),e=n.approvalImpact>0?"positive":n.approvalImpact<0?"negative":"neutral",t.events.recent.unshift({id:Date.now(),title:`Vote Result: ${a.title}`,description:`You chose to ${n.text.toLowerCase()} the proposal.`,type:"political",severity:e,week:t.time.week,year:t.time.year,timestamp:(new Date).toISOString()}),t.politics.nextVote=null,t.events.pending=t.events.pending.filter(e=>e.id!==i),this.eventSystem.emit("political:vote_completed",{vote:a,choice:n,gameState:t})}}handlePoliticalCrisis(e){const{gameState:t,crisis:i}=e;t.politics.approval=Math.max(0,t.politics.approval-i.approvalImpact),t.events.recent.unshift({id:Date.now(),title:`Political Crisis: ${i.title}`,description:i.description,type:"crisis",severity:"critical",week:t.time.week,year:t.time.year,timestamp:(new Date).toISOString()}),i.requiresVote&&this.createVote(t,{title:`Emergency Response: ${i.title}`,description:i.voteDescription,supportImpact:i.responseImpact?.support||0,opposeImpact:i.responseImpact?.oppose||0}),this.eventSystem.emit("political:crisis_triggered",{crisis:i,gameState:t})}triggerTestEvents(e){this.createVote(e,{title:"Healthcare Reform Bill",description:"A comprehensive healthcare reform proposal that would expand coverage but increase government spending.",supportImpact:3,opposeImpact:-1}),setTimeout(()=>{this.handlePoliticalCrisis({gameState:e,crisis:{title:"Budget Scandal",description:"Opposition has discovered irregularities in government spending.",approvalImpact:5,requiresVote:!0,voteDescription:"How should you respond to the budget scandal allegations?",responseImpact:{support:-2,oppose:-4}}})},5e3)}},o=e("c",new class{constructor(){this.eventSystem=i,this.activeEvents=[],this.scheduledVotes=[],this.politicalCrises=[],this.coalitionStability=100,this.lastEventTime=0,this.eventFrequency=4,this.initializeEventTypes(),this.setupEventListeners()}initializeEventTypes(){this.eventTypes={policyVotes:[{id:"tax_reform",title:"Tax Reform Bill",description:"A comprehensive tax reform package to modernize the tax system",type:"policy_vote",severity:"high",effects:{approval:{min:-8,max:12},gdp:{min:-.5,max:1.5},coalitionSupport:{min:-15,max:10}},options:[{id:"support",text:"Support the reform",description:"Back the tax reform package",effects:{approval:8,gdp:1.2,coalitionSupport:5}},{id:"oppose",text:"Oppose the reform",description:"Reject the tax reform package",effects:{approval:-3,gdp:-.2,coalitionSupport:-8}},{id:"modify",text:"Propose modifications",description:"Suggest amendments to the package",effects:{approval:2,gdp:.5,coalitionSupport:-2}}]},{id:"healthcare_funding",title:"Healthcare Funding Increase",description:"Proposal to increase healthcare funding by 20%",type:"policy_vote",severity:"medium",effects:{approval:{min:-5,max:15},debt:{min:.5,max:2},coalitionSupport:{min:-10,max:8}},options:[{id:"support",text:"Support increased funding",description:"Approve the healthcare budget increase",effects:{approval:12,debt:1.5,coalitionSupport:5}},{id:"oppose",text:"Oppose the increase",description:"Reject additional healthcare spending",effects:{approval:-5,debt:0,coalitionSupport:-7}}]}],coalitionEvents:[{id:"coalition_tension",title:"Coalition Partner Demands",description:"Your coalition partner is demanding more influence in key ministries",type:"coalition_crisis",severity:"medium",effects:{coalitionSupport:{min:-20,max:5},approval:{min:-5,max:3}},options:[{id:"concede",text:"Grant more influence",description:"Give coalition partner key ministry positions",effects:{coalitionSupport:10,approval:-2}},{id:"negotiate",text:"Negotiate compromise",description:"Find middle ground on ministry assignments",effects:{coalitionSupport:3,approval:1}},{id:"refuse",text:"Refuse demands",description:"Maintain current power structure",effects:{coalitionSupport:-15,approval:2}}]},{id:"cabinet_reshuffle",title:"Cabinet Reshuffle Pressure",description:"Political pressure mounts for a cabinet reshuffle",type:"political_pressure",severity:"medium",effects:{approval:{min:-8,max:10},coalitionSupport:{min:-10,max:15}},options:[{id:"reshuffle",text:"Conduct reshuffle",description:"Replace underperforming ministers",effects:{approval:6,coalitionSupport:8}},{id:"minor_changes",text:"Make minor changes",description:"Limited portfolio adjustments",effects:{approval:2,coalitionSupport:3}},{id:"no_changes",text:"No changes",description:"Maintain current cabinet",effects:{approval:-4,coalitionSupport:-5}}]}],oppositionEvents:[{id:"no_confidence_motion",title:"No Confidence Motion",description:"The opposition has filed a motion of no confidence against your government",type:"political_crisis",severity:"high",effects:{approval:{min:-15,max:5},coalitionSupport:{min:-25,max:10}},options:[{id:"rally_support",text:"Rally coalition support",description:"Work to ensure coalition unity against the motion",effects:{approval:2,coalitionSupport:8}},{id:"public_campaign",text:"Launch public campaign",description:"Take your case directly to the people",effects:{approval:5,coalitionSupport:-2}},{id:"policy_concessions",text:"Make policy concessions",description:"Offer compromise on controversial policies",effects:{approval:-2,coalitionSupport:5}}]}],economicEvents:[{id:"interest_rate_pressure",title:"Interest Rate Decision Pressure",description:"Central bank independence is being questioned amid economic pressures",type:"economic_policy",severity:"medium",effects:{gdp:{min:-1,max:.8},inflation:{min:-.5,max:1.2},approval:{min:-10,max:8}},options:[{id:"defend_independence",text:"Defend central bank independence",description:"Support the central bank's autonomy",effects:{gdp:.3,inflation:-.2,approval:3}},{id:"pressure_rates",text:"Pressure for rate changes",description:"Advocate for specific monetary policy",effects:{gdp:-.2,inflation:.8,approval:-5}}]}]}}setupEventListeners(){this.eventSystem.on("game:turn_processed",e=>{this.processPoliticalEvents(e.data.gameState)}),this.eventSystem.on("political:event_response",e=>{this.handleEventResponse(e.data)}),this.eventSystem.on("political:schedule_vote",e=>{this.scheduleVote(e.data)})}processPoliticalEvents(e){const{time:t,politics:i}=e,s=t.week+52*(t.year-1);this.updateCoalitionStability(i),this.processScheduledVotes(s,e),this.generateRandomEvents(s,e),this.processPoliticalCrises(e)}updateCoalitionStability(e){const t=.1*(e.approval-50),i=.05*e.coalition.reduce((e,t)=>e+t.support,0),s=.02*(75-this.coalitionStability);this.coalitionStability+=t+i+s,this.coalitionStability=Math.max(0,Math.min(100,this.coalitionStability))}generateRandomEvents(e,t){if(e-this.lastEventTime<this.eventFrequency)return;const i=this.calculateEventProbability(t);if(Math.random()<i){const i=this.selectEventType(t),s=this.createEvent(i,t);s&&(this.triggerEvent(s,t),this.lastEventTime=e)}}calculateEventProbability(e){let t=.3;return e.politics.approval<40&&(t+=.2),this.coalitionStability<60&&(t+=.15),e.politics.nextElection.week+52*(e.politics.nextElection.year-e.time.year)<52&&(t+=.1),Math.min(t,.8)}selectEventType(e){const t={policyVotes:30,coalitionEvents:25,oppositionEvents:20,economicEvents:25};this.coalitionStability<60&&(t.coalitionEvents+=20),e.politics.approval<40&&(t.oppositionEvents+=15),e.economy.gdpGrowth<1&&(t.economicEvents+=15);const i=Object.values(t).reduce((e,t)=>e+t,0);let s=Math.random()*i;const a=Object.entries(t).find(([e,t])=>(s-=t,s<=0));return a?a[0]:"policyVotes"}createEvent(e,t){const i=this.eventTypes[e];if(!i||0===i.length)return null;const s=i[Math.floor(Math.random()*i.length)];return{...s,id:`${s.id}_${Date.now()}`,triggeredWeek:t.time.week,triggeredYear:t.time.year,deadline:this.calculateDeadline(s,t),status:"pending"}}calculateDeadline(e,t){let i;return i="high"===e.severity?1:"medium"===e.severity?2:3,{week:t.time.week+i,year:t.time.year+Math.floor((t.time.week+i-1)/52)}}triggerEvent(e,t){this.activeEvents.push(e),this.eventSystem.emit("political:event_triggered",{event:e,gameState:t}),this.eventSystem.emit("game:add_event",{title:e.title,description:e.description,type:"political",severity:e.severity,requiresResponse:!0,eventId:e.id})}handleEventResponse(e){const{eventId:t,optionId:i,gameState:s}=e,a=this.activeEvents.find(e=>e.id===t);if(!a)return;const n=a.options.find(e=>e.id===i);if(!n)return;const o=this.applyEventEffects(n.effects,s);a.status="resolved",a.response=i,a.resolvedWeek=s.time.week,a.resolvedYear=s.time.year,this.activeEvents=this.activeEvents.filter(e=>e.id!==t),this.eventSystem.emit("political:event_resolved",{event:a,option:n,effects:o,gameState:s}),this.eventSystem.emit("game:add_event",{title:`Resolved: ${a.title}`,description:`${n.description}. ${this.formatEffects(o)}`,type:"political",severity:"neutral"})}applyEventEffects(e,t){const i={};if(void 0!==e.approval){const s=e.approval*(.8+.4*Math.random());t.politics.approval=Math.max(0,Math.min(100,t.politics.approval+s)),i.approval=s}if(void 0!==e.gdp){const s=e.gdp*(.8+.4*Math.random());t.economy.gdpGrowth=Math.max(-5,Math.min(10,t.economy.gdpGrowth+s)),i.gdp=s}if(void 0!==e.debt){const s=e.debt*(.8+.4*Math.random()),a=t.country.debt/t.country.gdp*100,n=Math.max(0,Math.min(200,a+s));t.country.debt=n/100*t.country.gdp,i.debt=s}if(void 0!==e.coalitionSupport){const s=e.coalitionSupport*(.8+.4*Math.random());this.coalitionStability=Math.max(0,Math.min(100,this.coalitionStability+s)),t.politics.coalition.forEach(e=>{const t=s*(.5+.5*Math.random());e.support=Math.max(0,Math.min(100,e.support+t))}),i.coalitionSupport=s}return i}formatEffects(e){const t=[];return e.approval&&t.push(`Approval ${e.approval>0?"+":""}${e.approval.toFixed(1)}%`),e.gdp&&t.push(`GDP Growth ${e.gdp>0?"+":""}${e.gdp.toFixed(1)}%`),e.coalitionSupport&&t.push(`Coalition ${e.coalitionSupport>0?"+":""}${e.coalitionSupport.toFixed(1)}%`),t.length>0?`Effects: ${t.join(", ")}`:""}scheduleVote(e){this.scheduledVotes.push({...e,scheduledWeek:e.week,scheduledYear:e.year,status:"scheduled"})}processScheduledVotes(e,t){this.scheduledVotes.filter(t=>t.scheduledWeek+52*(t.scheduledYear-1)<=e&&"scheduled"===t.status).forEach(e=>{this.processVote(e,t),e.status="processed"}),this.scheduledVotes=this.scheduledVotes.filter(e=>"processed"!==e.status)}processVote(e,t){const i=this.simulateVoteOutcome(e,t);this.eventSystem.emit("political:vote_completed",{vote:e,outcome:i,gameState:t})}simulateVoteOutcome(e,t){const i=t.politics.coalition.reduce((e,t)=>e+t.support,0)/100,s=.01*(t.politics.approval-50),a=.01*(this.coalitionStability-50),n=Math.max(.1,Math.min(.9,i+s+a));return{passed:Math.random()<n,margin:Math.floor(20*Math.random())+1,coalitionUnity:this.coalitionStability}}processPoliticalCrises(e){this.politicalCrises.forEach(t=>{t.duration+=1,t.duration>t.maxDuration&&this.resolveCrisis(t,e)}),this.politicalCrises=this.politicalCrises.filter(e=>"resolved"!==e.status)}resolveCrisis(e,t){e.status="resolved";const i=e.resolutionEffects;this.applyEventEffects(i,t),this.eventSystem.emit("political:crisis_resolved",{crisis:e,effects:i,gameState:t})}getActiveEvents(){return this.activeEvents.slice()}getCoalitionStability(){return this.coalitionStability}getPoliticalStatus(e){return{coalitionStability:this.coalitionStability,activeEvents:this.activeEvents.length,scheduledVotes:this.scheduledVotes.length,politicalPressure:this.calculatePoliticalPressure(e),nextElectionWeeks:this.calculateWeeksUntilElection(e)}}calculatePoliticalPressure(e){let t=0;return e.politics.approval<40&&(t+=30),this.coalitionStability<60&&(t+=25),this.activeEvents.length>2&&(t+=20),e.economy.gdpGrowth<1&&(t+=15),Math.min(100,t)}calculateWeeksUntilElection(e){const t=e.time.week+52*(e.time.year-1),i=e.politics.nextElection.week+52*(e.politics.nextElection.year-1);return Math.max(0,i-t)}}),r=new class{constructor(){this.eventSystem=i,this.achievements=new Map,this.setupEventListeners(),this.initializeAchievements()}setupEventListeners(){this.eventSystem.on(t.TURN_END,e=>{this.checkWinConditions(e.data.gameState),this.checkAchievements(e.data.gameState)}),this.eventSystem.on("political:election",e=>{this.handleElectionResult(e.data)}),this.eventSystem.on("political:approval_change",e=>{this.checkApprovalMilestones(e.data)})}initializeAchievements(){[{id:"popular_leader",title:"Popular Leader",description:"Maintain 70%+ approval rating for 12 consecutive weeks",icon:"‚≠ê",type:"approval",requirement:{threshold:70,duration:12},unlocked:!1},{id:"economic_miracle",title:"Economic Miracle",description:"Achieve 5%+ GDP growth with unemployment below 4%",icon:"üìà",type:"economic",requirement:{gdpGrowth:5,unemployment:4},unlocked:!1},{id:"crisis_manager",title:"Crisis Manager",description:"Successfully handle 3 political crises without losing more than 5% approval total",icon:"üõ°Ô∏è",type:"crisis",requirement:{crises:3,maxApprovalLoss:5},progress:{handledCrises:0,totalApprovalLoss:0},unlocked:!1},{id:"diplomatic_master",title:"Diplomatic Master",description:'Achieve "Excellent" international standing',icon:"üåç",type:"diplomatic",requirement:{standing:"Excellent"},unlocked:!1},{id:"first_term_success",title:"First Term Success",description:"Complete your first term with 60%+ approval",icon:"üèÜ",type:"milestone",requirement:{term:1,approval:60},unlocked:!1},{id:"landslide_victory",title:"Landslide Victory",description:"Win an election with 65%+ approval",icon:"üéØ",type:"election",requirement:{approval:65},unlocked:!1},{id:"balanced_budget",title:"Fiscal Responsibility",description:"Reduce national debt below 50% of GDP",icon:"üí∞",type:"economic",requirement:{debtRatio:50},unlocked:!1},{id:"policy_master",title:"Policy Master",description:"Successfully pass 10 major policy votes",icon:"üìú",type:"policy",requirement:{policies:10},progress:{passedPolicies:0},unlocked:!1}].forEach(e=>{this.achievements.set(e.id,e)})}checkWinConditions(e){this.checkLossConditions(e)||this.checkVictoryConditions(e)}checkLossConditions(e){const{approval:t}=e.politics;return t<15?(this.triggerGameEnd(e,{type:"defeat",reason:"approval_collapse",title:"Government Collapse",description:`Your approval rating has collapsed to ${t.toFixed(1)}%. The government has lost all confidence and you have been forced to resign.`,finalStats:this.getFinalStats(e)}),!0):e.economy.unemployment>15&&e.economy.gdpGrowth<-5?(this.triggerGameEnd(e,{type:"defeat",reason:"economic_collapse",title:"Economic Collapse",description:`The economy has collapsed with ${e.economy.unemployment}% unemployment and ${e.economy.gdpGrowth}% GDP contraction. \n        The country is in crisis and you have been removed from office.`,finalStats:this.getFinalStats(e)}),!0):!!(e.scandals&&e.scandals.active.length>=3&&e.scandals.active.filter(e=>"major"===e.severity).length>=2)&&(this.triggerGameEnd(e,{type:"defeat",reason:"scandal_overload",title:"Political Scandals",description:"Multiple major scandals have overwhelmed your administration. Parliament has voted no confidence and you must resign.",finalStats:this.getFinalStats(e)}),!0)}checkVictoryConditions(e){const{approval:t}=e.politics,i=e.time.year;return i>=8&&t>=50?(this.triggerGameEnd(e,{type:"victory",reason:"successful_leadership",title:"Successful Leadership",description:`Congratulations! You have successfully led the country for ${i} years with a final approval rating of ${t.toFixed(1)}%. Your legacy is secure.`,finalStats:this.getFinalStats(e)}),!0):t>=80&&i>=4&&(this.triggerGameEnd(e,{type:"victory",reason:"beloved_leader",title:"Beloved Leader",description:`You are universally beloved with an exceptional ${t.toFixed(1)}% approval rating. You have achieved legendary status as a leader.`,finalStats:this.getFinalStats(e)}),!0)}checkAchievements(e){this.achievements.forEach((t,i)=>{t.unlocked||this.isAchievementMet(t,e)&&this.unlockAchievement(i,e)})}isAchievementMet(e,t){const{approval:i}=t.politics,{economy:s}=t;switch(e.type){case"approval":return e.progress||(e.progress={consecutiveWeeks:0}),i>=e.requirement.threshold?e.progress.consecutiveWeeks+=1:e.progress.consecutiveWeeks=0,e.progress.consecutiveWeeks>=e.requirement.duration;case"economic":if("economic_miracle"===e.id)return s.gdpGrowth>=e.requirement.gdpGrowth&&s.unemployment<=e.requirement.unemployment;if("balanced_budget"===e.id)return t.country.debt/t.country.gdp*100<e.requirement.debtRatio;break;case"diplomatic":return t.global.internationalStanding===e.requirement.standing;case"milestone":if("first_term_success"===e.id)return t.time.year>=4&&i>=e.requirement.approval;break;case"crisis":return e.progress||(e.progress={handledCrises:0,totalApprovalLoss:0}),e.progress.handledCrises>=e.requirement.crises&&e.progress.totalApprovalLoss<=e.requirement.maxApprovalLoss;case"policy":return e.progress||(e.progress={passedPolicies:0}),e.progress.passedPolicies>=e.requirement.policies;default:return!1}return!1}unlockAchievement(e,t){const i=this.achievements.get(e);i&&!i.unlocked&&(i.unlocked=!0,i.unlockedAt={week:t.time.week,year:t.time.year,timestamp:(new Date).toISOString()},this.eventSystem.emit("achievement:unlocked",{achievement:i,gameState:t}),t.events.recent.unshift({id:Date.now(),title:`Achievement Unlocked: ${i.title}`,description:i.description,type:"achievement",severity:"positive",icon:i.icon,week:t.time.week,year:t.time.year,timestamp:(new Date).toISOString()}))}handleElectionResult(e){const{result:t,approval:i,gameState:s}=e;"victory"===t&&i>=65&&this.unlockAchievement("landslide_victory",s),"defeat"===t&&this.triggerGameEnd(s,{type:"defeat",reason:"election_loss",title:"Election Defeat",description:`You lost the election with ${i.toFixed(1)}% approval. The people have chosen new leadership.`,finalStats:this.getFinalStats(s)})}checkApprovalMilestones(e){e.newApproval<=25&&this.eventSystem.emit("political:crisis",{gameState:e.gameState,crisis:{title:"Confidence Crisis",description:"Your low approval rating has triggered a confidence crisis.",approvalImpact:2,requiresVote:!1}})}triggerGameEnd(e,t){e.gameEnded=!0,e.endCondition=t,this.eventSystem.emit("game:end",{gameState:e,endCondition:t})}getFinalStats(e){const t=`${e.time.year} years, ${e.time.week} weeks`,i=Array.from(this.achievements.values()).filter(e=>e.unlocked);return{timeInOffice:t,finalApproval:e.politics.approval,finalGDPGrowth:e.economy.gdpGrowth,finalUnemployment:e.economy.unemployment,finalInflation:e.economy.inflation,achievementsUnlocked:i.length,achievements:i,internationalStanding:e.global.internationalStanding}}getAllAchievements(){return Array.from(this.achievements.values())}getUnlockedAchievements(){return Array.from(this.achievements.values()).filter(e=>e.unlocked)}resetAchievements(){this.achievements.forEach(e=>{e.unlocked=!1,"crisis"===e.type?e.progress={handledCrises:0,totalApprovalLoss:0}:"policy"===e.type?e.progress={passedPolicies:0}:"approval"===e.type?e.progress={consecutiveWeeks:0}:e.progress=void 0,delete e.unlockedAt})}},c=e("b",new class{constructor(){this.eventSystem=i,this.difficulties=this.initializeDifficulties(),this.setupEventListeners()}setupEventListeners(){this.eventSystem.on("game:reset_request",e=>{this.handleResetRequest(e.data)}),this.eventSystem.on("game:new_game",e=>{this.startNewGame(e.data)})}initializeDifficulties(){return{easy:{id:"easy",name:"Peaceful Times",description:"Start with higher approval and better economic conditions. Fewer crises.",icon:"üåû",modifiers:{startingApproval:60,economicStability:1.2,crisisFrequency:.5,approvalVolatility:.8,coalitionSupport:1.1},startingConditions:{approval:60,gdpGrowth:2.8,unemployment:5,inflation:2,debt:55}},normal:{id:"normal",name:"Balanced Challenge",description:"Standard difficulty with realistic political and economic challenges.",icon:"‚öñÔ∏è",modifiers:{startingApproval:50,economicStability:1,crisisFrequency:1,approvalVolatility:1,coalitionSupport:1},startingConditions:{approval:50,gdpGrowth:2.1,unemployment:6,inflation:2.4,debt:60}},hard:{id:"hard",name:"Crisis Management",description:"Start in difficult circumstances. More frequent crises and volatility.",icon:"‚ö°",modifiers:{startingApproval:35,economicStability:.8,crisisFrequency:1.5,approvalVolatility:1.3,coalitionSupport:.9},startingConditions:{approval:35,gdpGrowth:1.2,unemployment:7.5,inflation:3.2,debt:70}},expert:{id:"expert",name:"Political Nightmare",description:"Maximum difficulty. Inherit multiple crises and unstable conditions.",icon:"üî•",modifiers:{startingApproval:25,economicStability:.6,crisisFrequency:2,approvalVolatility:1.5,coalitionSupport:.8},startingConditions:{approval:25,gdpGrowth:.5,unemployment:9,inflation:4,debt:80}}}}handleResetRequest(e){const{currentGameState:t,resetType:i="full"}=e;"confirm"===i?this.showResetConfirmation(t):"new_game"===i?this.showNewGameDialog():this.performReset(t)}showResetConfirmation(e){const t=`${e.time.year} years, ${e.time.week} weeks`;this.eventSystem.emit("ui:show_modal",{title:"Reset Game",content:`\n        <div class="reset-confirmation">\n          <div class="warning-section">\n            <div class="warning-icon">‚ö†Ô∏è</div>\n            <h3>Are you sure you want to reset the game?</h3>\n            <p>This action cannot be undone. All progress will be lost.</p>\n          </div>\n          \n          <div class="current-progress">\n            <h4>Current Progress:</h4>\n            <div class="progress-stats">\n              <div class="stat">\n                <span class="label">Time in Office:</span>\n                <span class="value">${t}</span>\n              </div>\n              <div class="stat">\n                <span class="label">Approval Rating:</span>\n                <span class="value">${e.politics.approval.toFixed(1)}%</span>\n              </div>\n              <div class="stat">\n                <span class="label">GDP Growth:</span>\n                <span class="value">${e.economy.gdpGrowth.toFixed(1)}%</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="reset-options">\n            <h4>Reset Options:</h4>\n            <div class="option-buttons">\n              <button class="reset-option-btn" data-type="full">\n                <div class="option-icon">üîÑ</div>\n                <div class="option-text">\n                  <strong>Full Reset</strong>\n                  <span>Start completely over</span>\n                </div>\n              </button>\n              <button class="reset-option-btn" data-type="new_game">\n                <div class="option-icon">üÜï</div>\n                <div class="option-text">\n                  <strong>New Game</strong>\n                  <span>Choose difficulty & settings</span>\n                </div>\n              </button>\n            </div>\n          </div>\n        </div>\n        \n        <style>\n          .reset-confirmation {\n            max-width: 500px;\n            margin: 0 auto;\n          }\n          .warning-section {\n            text-align: center;\n            margin-bottom: var(--spacing-lg);\n            padding: var(--spacing-md);\n            background: rgba(229, 62, 62, 0.1);\n            border-radius: var(--border-radius);\n            border: 1px solid rgba(229, 62, 62, 0.3);\n          }\n          .warning-icon {\n            font-size: 2rem;\n            margin-bottom: var(--spacing-sm);\n          }\n          .warning-section h3 {\n            color: var(--accent-color);\n            margin: 0 0 var(--spacing-sm) 0;\n          }\n          .current-progress {\n            margin-bottom: var(--spacing-lg);\n          }\n          .progress-stats {\n            display: flex;\n            flex-direction: column;\n            gap: var(--spacing-xs);\n          }\n          .stat {\n            display: flex;\n            justify-content: space-between;\n            padding: var(--spacing-xs) 0;\n            border-bottom: 1px solid var(--border-light);\n          }\n          .stat:last-child {\n            border-bottom: none;\n          }\n          .label {\n            color: var(--text-light);\n          }\n          .value {\n            font-weight: 600;\n            color: var(--text-color);\n          }\n          .reset-options h4 {\n            margin-bottom: var(--spacing-md);\n          }\n          .option-buttons {\n            display: flex;\n            flex-direction: column;\n            gap: var(--spacing-sm);\n          }\n          .reset-option-btn {\n            display: flex;\n            align-items: center;\n            gap: var(--spacing-md);\n            width: 100%;\n            padding: var(--spacing-md);\n            border: 2px solid var(--border-color);\n            background: var(--surface-color);\n            border-radius: var(--border-radius);\n            cursor: pointer;\n            transition: all var(--transition-base);\n          }\n          .reset-option-btn:hover {\n            border-color: var(--secondary-color);\n            background: var(--background-alt);\n          }\n          .option-icon {\n            font-size: 1.5rem;\n          }\n          .option-text {\n            text-align: left;\n          }\n          .option-text strong {\n            display: block;\n            color: var(--text-color);\n            margin-bottom: var(--spacing-xs);\n          }\n          .option-text span {\n            color: var(--text-light);\n            font-size: 0.875rem;\n          }\n        </style>\n      `,confirmText:"Cancel",showCancel:!1,onConfirm:()=>!0})}showNewGameDialog(){const e=Object.values(this.difficulties).map(e=>`\n      <div class="difficulty-option" data-difficulty="${e.id}">\n        <div class="difficulty-header">\n          <span class="difficulty-icon">${e.icon}</span>\n          <h4>${e.name}</h4>\n        </div>\n        <p class="difficulty-description">${e.description}</p>\n        <div class="difficulty-stats">\n          <div class="stat-item">\n            <span>Starting Approval:</span>\n            <span>${e.startingConditions.approval}%</span>\n          </div>\n          <div class="stat-item">\n            <span>GDP Growth:</span>\n            <span>${e.startingConditions.gdpGrowth}%</span>\n          </div>\n          <div class="stat-item">\n            <span>Unemployment:</span>\n            <span>${e.startingConditions.unemployment}%</span>\n          </div>\n        </div>\n      </div>\n    `).join("");this.eventSystem.emit("ui:show_modal",{title:"New Game Setup",content:`\n        <div class="new-game-setup">\n          <div class="setup-section">\n            <h3>Choose Difficulty Level</h3>\n            <p>Select the challenge level for your political career:</p>\n            <div class="difficulty-grid">\n              ${e}\n            </div>\n          </div>\n\n          <div class="setup-section">\n            <h3>Game Options</h3>\n            <div class="game-options">\n              <label class="option-checkbox">\n                <input type="checkbox" id="tutorial-enabled" checked>\n                <span>Enable tutorial and hints</span>\n              </label>\n              <label class="option-checkbox">\n                <input type="checkbox" id="auto-save" checked>\n                <span>Enable auto-save every 4 weeks</span>\n              </label>\n              <label class="option-checkbox">\n                <input type="checkbox" id="crisis-events" checked>\n                <span>Enable random crisis events</span>\n              </label>\n            </div>\n          </div>\n        </div>\n\n        <style>\n          .new-game-setup {\n            max-width: 600px;\n            margin: 0 auto;\n          }\n          .setup-section {\n            margin-bottom: var(--spacing-xl);\n          }\n          .setup-section h3 {\n            color: var(--primary-color);\n            margin-bottom: var(--spacing-sm);\n          }\n          .difficulty-grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: var(--spacing-md);\n            margin-top: var(--spacing-md);\n          }\n          .difficulty-option {\n            padding: var(--spacing-md);\n            border: 2px solid var(--border-color);\n            border-radius: var(--border-radius);\n            cursor: pointer;\n            transition: all var(--transition-base);\n            background: var(--surface-color);\n          }\n          .difficulty-option:hover {\n            border-color: var(--secondary-color);\n            background: var(--background-alt);\n          }\n          .difficulty-option.selected {\n            border-color: var(--secondary-color);\n            background: rgba(49, 130, 206, 0.1);\n          }\n          .difficulty-header {\n            display: flex;\n            align-items: center;\n            gap: var(--spacing-sm);\n            margin-bottom: var(--spacing-sm);\n          }\n          .difficulty-icon {\n            font-size: 1.5rem;\n          }\n          .difficulty-header h4 {\n            margin: 0;\n            color: var(--text-color);\n          }\n          .difficulty-description {\n            color: var(--text-light);\n            font-size: 0.875rem;\n            margin-bottom: var(--spacing-sm);\n          }\n          .difficulty-stats {\n            display: flex;\n            flex-direction: column;\n            gap: var(--spacing-xs);\n          }\n          .stat-item {\n            display: flex;\n            justify-content: space-between;\n            font-size: 0.8rem;\n          }\n          .stat-item span:first-child {\n            color: var(--text-light);\n          }\n          .stat-item span:last-child {\n            font-weight: 600;\n            color: var(--text-color);\n          }\n          .game-options {\n            display: flex;\n            flex-direction: column;\n            gap: var(--spacing-sm);\n          }\n          .option-checkbox {\n            display: flex;\n            align-items: center;\n            gap: var(--spacing-sm);\n            cursor: pointer;\n          }\n          .option-checkbox input {\n            margin: 0;\n          }\n          \n          @media (max-width: 768px) {\n            .difficulty-grid {\n              grid-template-columns: 1fr;\n            }\n          }\n        </style>\n      `,confirmText:"Start New Game",cancelText:"Cancel",showCancel:!0,onConfirm:()=>{const e=document.querySelector(".difficulty-option.selected");if(!e)return!1;const t=e.getAttribute("data-difficulty"),i={tutorial:document.getElementById("tutorial-enabled")?.checked||!1,autoSave:document.getElementById("auto-save")?.checked||!1,crisisEvents:document.getElementById("crisis-events")?.checked||!1};return this.startNewGame({difficulty:t,options:i}),!0}}),setTimeout(()=>{const e=document.querySelectorAll(".difficulty-option");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected")})});const t=document.querySelector('[data-difficulty="normal"]');t&&t.classList.add("selected")},100)}startNewGame(e={}){const t=this.difficulties[e.difficulty||"normal"],i=e.options||{},s=this.createNewGameState(t,i);this.eventSystem.emit("game:reset",{newGameState:s,difficulty:t,options:i}),this.eventSystem.emit("ui:notification",{message:`New game started on ${t.name} difficulty!`,type:"success"})}createNewGameState(e,t){const i=new Date,s=e.startingConditions;return{version:"1.0.0",difficulty:e.id,options:t,player:{name:"Player",party:"Independent",experience:0,skills:{economics:{level:1,experience:0},diplomacy:{level:1,experience:0},communication:{level:1,experience:0},leadership:{level:1,experience:0}}},country:{name:"Democracia",population:5e7,gdp:1e12,debt:s.debt/100*1e12,stability:75},economy:{gdpGrowth:s.gdpGrowth,unemployment:s.unemployment,inflation:s.inflation,interestRate:3.5,sectors:{agriculture:5,manufacturing:25,services:70}},politics:{approval:s.approval,coalition:[{party:"Government",support:45*e.modifiers.coalitionSupport},{party:"Coalition Partner",support:22*e.modifiers.coalitionSupport}],opposition:[{party:"Main Opposition",support:30},{party:"Minor Opposition",support:3}],nextElection:{year:4,week:1},nextVote:null},global:{relations:{"United Federation":75,"Eastern Empire":60,"Southern Union":80},tradeBalance:15e9,internationalStanding:"Good"},time:{startDate:i.toISOString(),currentDate:i.toISOString(),week:1,year:1},events:{recent:[{id:Date.now(),title:"Game Started",description:`Welcome to SP_Sim! You've been elected as the new leader. Starting difficulty: ${e.name}`,type:"system",severity:"neutral",week:1,year:1,timestamp:i.toISOString()}],pending:[]},scandals:{active:[],resolved:[]},achievements:{unlocked:[],progress:{}},gameEnded:!1,endCondition:null}}performReset(e){this.startNewGame({difficulty:"normal"})}getDifficulties(){return Object.values(this.difficulties)}getDifficulty(e){return this.difficulties[e]}}),l=e("d",new class{constructor(){this.eventSystem=i,this.oppositionParties=[],this.currentStance="neutral",this.aggressiveness=.5,this.strategy="balanced",this.recentActions=[],this.policyPositions=new Map,this.debateHistory=[],this.initializeOppositionParties(),this.initializeEventListeners()}initializeOppositionParties(){this.oppositionParties=[{id:"main_opposition",name:"Main Opposition",support:30,ideology:"center-right",personality:"aggressive",aggressiveness:.7,expertise:["economy","defense"],approval:45,leadership:"strong"},{id:"minor_opposition",name:"Progressive Alliance",support:15,ideology:"left",personality:"principled",aggressiveness:.4,expertise:["social","environment"],approval:35,leadership:"moderate"},{id:"populist_party",name:"People's Voice",support:8,ideology:"populist",personality:"opportunistic",aggressiveness:.9,expertise:["populism","media"],approval:25,leadership:"charismatic"}]}initializeEventListeners(){this.eventSystem.on(t.POLICY_PROPOSED,e=>{this.handlePolicyProposal(e.data)}),this.eventSystem.on("economic:update",e=>{this.handleEconomicUpdate(e.data)}),this.eventSystem.on(t.APPROVAL_CHANGE,e=>{this.handleApprovalChange(e.data)}),this.eventSystem.on(t.TURN_END,e=>{this.processTurn(e.data.gameState)})}processTurn(e){this.updateStrategy(e),this.generateOppositionActions(e),this.updatePartyStandings(e),this.cleanupOldActions()}analyzeGameState(e){if(!e||!e.politics||!e.economy)return void console.warn("AIOpposition: Invalid gameState provided to analyzeGameState");const t=e.politics.approval,i=this.calculateEconomicHealth(e),s=this.calculateTimeToElection(e);let a="low";t<40?a="high":t<60&&(a="medium");let n="normal";i<.4?n="crisis":s<20&&(n="election"),this.lastAnalysis={playerApproval:t,economicHealth:i,timeToElection:s,analysisTime:Date.now(),weakness:a,opportunity:n},this.eventSystem.emit("ai:analysis_complete",{analysis:this.lastAnalysis,strategy:this.strategy,aggressiveness:this.aggressiveness})}updateStrategy(e){const t=e.politics.approval,i=this.calculateEconomicHealth(e),s=this.calculateTimeToElection(e);t<40?(this.aggressiveness=Math.min(1,this.aggressiveness+.1),this.strategy="aggressive"):t>60&&(this.aggressiveness=Math.max(.3,this.aggressiveness-.05),this.strategy="defensive"),s<20&&(this.aggressiveness=Math.min(1,this.aggressiveness+.2)),i<.4&&(this.strategy="opportunistic",this.aggressiveness=Math.min(1,this.aggressiveness+.15))}generateOppositionActions(e){const t=[];Math.random()<.4*this.aggressiveness&&t.push(this.generateCriticism(e)),Math.random()<.3&&t.push(this.generateAlternativePolicy(e)),Math.random()<.2*this.aggressiveness&&t.push(this.generateDebateCall(e)),t.forEach(t=>{t&&this.executeOppositionAction(t,e)})}generateCriticism(e){const t=[],{economy:i}=e,{approval:s}=e.politics;return i.unemployment>6.5&&t.push({type:"criticism",target:"unemployment",severity:"high",message:"Government policies have failed to address rising unemployment",impact:{approval:-2,support:1}}),i.inflation>3.5&&t.push({type:"criticism",target:"inflation",severity:"medium",message:"Inflationary pressure threatens household budgets",impact:{approval:-1.5,support:.5}}),i.gdpGrowth<1&&t.push({type:"criticism",target:"growth",severity:"high",message:"Economic stagnation under current leadership",impact:{approval:-2.5,support:1.5}}),s<45&&t.push({type:"criticism",target:"leadership",severity:"medium",message:"Loss of public confidence demands new direction",impact:{approval:-1,support:.8}}),t.length>0?t[Math.floor(Math.random()*t.length)]:null}generateAlternativePolicy(e){const t=[],{economy:i}=e;return i.unemployment>5.5&&t.push({type:"policy_proposal",area:"employment",title:"Job Creation Initiative",description:"Comprehensive employment program targeting youth and long-term unemployed",proposedBy:this.getRandomOppositionParty(),impact:{unemployment:-.8,debt:2,approval:1.5},cost:5e9}),i.inflation>3&&t.push({type:"policy_proposal",area:"monetary",title:"Inflation Control Measures",description:"Targeted intervention to control rising prices",proposedBy:this.getRandomOppositionParty(),impact:{inflation:-.5,growth:-.2,approval:1},cost:2e9}),t.length>0?t[0]:null}generateDebateCall(e){return Math.random()<.7?{type:"debate_call",title:"Parliamentary Question Time",description:"Opposition demands answers on recent policy decisions",urgency:this.aggressiveness>.7?"high":"medium",proposedBy:this.getRandomOppositionParty(),topics:this.generateDebateTopics(e)}:null}generateDebateTopics(e){const t=[],{economy:i}=e;i.unemployment>6&&t.push("unemployment crisis"),i.inflation>3&&t.push("cost of living"),i.gdpGrowth<1.5&&t.push("economic stagnation"),e.politics.approval<45&&t.push("leadership crisis");const s=["budget allocation","healthcare reform","education funding","infrastructure"];return t.push(s[Math.floor(Math.random()*s.length)]),t.slice(0,3)}executeOppositionAction(e,t){this.recentActions.push({...e,timestamp:Date.now(),week:t.time.week,year:t.time.year}),this.eventSystem.emit("opposition:action",{action:e,gameState:t,oppositionStatus:this.getOppositionStatus()}),e.impact&&this.applyActionImpact(e.impact,t),console.log(`Opposition action: ${e.type} - ${e.title||e.message}`)}applyActionImpact(e,i){e.approval&&this.eventSystem.emit(t.APPROVAL_CHANGE,{change:e.approval,newApproval:i.politics.approval+e.approval,reason:"Opposition action"}),e.support&&this.oppositionParties.forEach(t=>{t.support+=e.support*(t.support/100)})}handleApprovalChange(e){const{change:t,newApproval:i}=e;if(Math.abs(t)>3&&t<0&&Math.random()<.6*this.aggressiveness){const e={type:"criticism",target:"leadership",severity:"medium",message:`${this.getRandomOppositionParty().name} questions government leadership as approval falls`,impact:{support:.5}};setTimeout(()=>{this.executeOppositionAction(e,{politics:{approval:i}})},1e3+2e3*Math.random())}}handlePolicyProposal(e){const t=this.generatePolicyResponse(e);t&&setTimeout(()=>{this.eventSystem.emit("opposition:policy_response",{policy:e,response:t,oppositionParty:this.getRandomOppositionParty()})},2e3+3e3*Math.random())}generatePolicyResponse(e){const t=this.getRandomOppositionParty(),i=[];return"economic"===e.area&&"center-right"===t.ideology&&i.push({stance:"oppose",reason:"fiscal_responsibility",message:`${t.name} opposes this policy due to concerns about fiscal impact`,severity:t.aggressiveness}),"social"===e.area&&"left"===t.ideology&&i.push({stance:"support_with_amendments",reason:"insufficient_scope",message:`${t.name} supports the direction but demands stronger measures`,severity:.3}),0===i.length&&i.push({stance:Math.random()<.6?"oppose":"conditional_support",reason:"political_disagreement",message:`${t.name} questions the effectiveness of this approach`,severity:.7*t.aggressiveness}),i[0]}handleEconomicUpdate(e){this.identifySignificantChanges(e).forEach(e=>{Math.random()<.5*this.aggressiveness&&this.generateEconomicResponse(e)})}identifySignificantChanges(e){const t=[];return e.unemployment&&e.unemployment>7&&t.push({type:"unemployment_rise",severity:"high",data:e}),e.inflation&&e.inflation>4&&t.push({type:"inflation_spike",severity:"high",data:e}),e.gdpGrowth&&e.gdpGrowth<0&&t.push({type:"recession_risk",severity:"critical",data:e}),t}generateEconomicResponse(e){const t=this.getRandomOppositionParty(),i={type:"economic_response",change:e,party:t,message:this.generateEconomicMessage(e,t),urgency:"critical"===e.severity?"high":"medium"};this.eventSystem.emit("opposition:economic_response",i)}generateEconomicMessage(e,t){const i={unemployment_rise:[`${t.name} demands immediate action on rising unemployment`,"Government's economic policies clearly failing working families","Unemployment crisis demands new leadership approach"],inflation_spike:[`${t.name} warns of cost-of-living crisis for ordinary citizens`,"Inflation spiraling out of control under current government","Immediate intervention needed to protect household budgets"],recession_risk:[`${t.name} calls emergency session on recession threat`,"Economic crisis demands bipartisan response","Government's economic incompetence threatens national stability"]}[e.type]||["Opposition concerned about economic direction"];return i[Math.floor(Math.random()*i.length)]}getRandomOppositionParty(){const e=this.oppositionParties.reduce((e,t)=>e+t.support,0),t=Math.random()*e;let i=0;const s=this.oppositionParties.find(e=>(i+=e.support,t<=i));return s||this.oppositionParties[0]}updatePartyStandings(e){this.oppositionParties.forEach(t=>{e.politics.approval<40&&(t.support+=.5*Math.random(),t.approval+=1*Math.random()),this.calculateEconomicHealth(e)<.5&&(t.support+=.3*Math.random()),t.support=Math.min(45,Math.max(5,t.support)),t.approval=Math.min(70,Math.max(15,t.approval))})}calculateEconomicHealth(e){const{economy:t}=e;return(Math.max(0,Math.min(1,(10-t.unemployment)/5))+Math.max(0,Math.min(1,(5-t.inflation)/3))+Math.max(0,Math.min(1,t.gdpGrowth/4)))/3}calculateTimeToElection(e){const t=e.time.week+52*(e.time.year-1),i=e.politics.nextElection.week+52*(e.politics.nextElection.year-1);return Math.max(0,i-t)}cleanupOldActions(){this.recentActions.length>10&&(this.recentActions=this.recentActions.slice(-10))}getOppositionStatus(){return{parties:[...this.oppositionParties],strategy:this.strategy,aggressiveness:this.aggressiveness,recentActions:[...this.recentActions.slice(-5)],totalSupport:this.oppositionParties.reduce((e,t)=>e+t.support,0),averageApproval:this.oppositionParties.reduce((e,t)=>e+t.approval,0)/this.oppositionParties.length}}initiateDebate(e,t="medium"){const i=this.getRandomOppositionParty(),s={id:`debate_${Date.now()}`,topic:e,urgency:t,initiator:i,status:"pending",timestamp:Date.now(),arguments:this.generateDebateArguments(e,i),publicInterest:.5*Math.random()+.3};return this.debateHistory.push(s),this.eventSystem.emit("opposition:debate_initiated",{debate:s,requiredResponse:"high"===t}),s}generateDebateArguments(e,t){return({unemployment:["Government policies have failed to create sustainable employment","Small businesses need more support to hire workers","Investment in infrastructure would create immediate jobs"],inflation:["Rising costs are hurting working families the most","Government spending is driving inflation higher","Immediate price controls needed on essential goods"],healthcare:["Healthcare system is failing those who need it most","More funding needed for public health services","Private sector partnerships could improve efficiency"]}[e]||["This policy requires serious reconsideration"]).map(e=>({argument:e,strength:.5*Math.random()+.5,party:t.name}))}handleDebateResponse(e,t){const i=this.debateHistory.find(t=>t.id===e);if(!i)return;i.playerResponse=t,i.status="completed";const s=this.calculateDebateOutcome(i,t);this.eventSystem.emit("opposition:debate_concluded",{debate:i,outcome:s,impact:s.impact})}calculateDebateOutcome(e,t){const i=.4*Math.random()+.3,s=Math.max(0,Math.min(1,i+({strong_defense:.2,compromise:.1,deflect:-.1,weak_response:-.2,no_response:-.3}[t.type]||0)));let a;const n={approval:0,support:0};return s>.6?(a="player_victory",n.approval=1+1.5*Math.random(),n.support=-.5*Math.random()):s>.4?(a="draw",n.approval=.5*Math.random()-.25):(a="opposition_victory",n.approval=-(1+1.5*Math.random()),n.support=.8*Math.random()),{outcome:a,score:s,impact:n}}getDebateHistory(){return[...this.debateHistory]}reset(){this.currentStance="neutral",this.aggressiveness=.5,this.strategy="balanced",this.recentActions=[],this.policyPositions.clear(),this.debateHistory=[],this.initializeOppositionParties()}}),p=new class{constructor(){this.eventSystem=i,this.modals=new Set,this.eventSystem.on("modal:show",e=>{e.data&&e.data.modal&&this.modals.add(e.data.modal)}),this.eventSystem.on("modal:hide",e=>{e.data&&e.data.modal&&this.modals.delete(e.data.modal)}),this.eventSystem.on("game:reset",()=>{this.cleanup()}),this.eventSystem.on("game:start",()=>{this.cleanup()})}cleanup(){this.modals.forEach(e=>{"function"==typeof e.destroy?e.destroy():"function"==typeof e.hide&&e.hide()}),this.modals.clear()}},m=e("m",new class{constructor(){this.initialized=!1,this.subscriptionTier="free",this.premiumFeatures=new Set,this.usageMetrics={sessionsCount:0,totalPlayTime:0,featuresUsed:new Set,scenariosCompleted:0,achievementsUnlocked:0},this.trials={premiumTrialUsed:!1,educationalTrialActive:!1,trialStartDate:null,trialEndDate:null},this.licenseInfo={type:"individual",institution:null,validUntil:null,features:[]},this.setupEventListeners(),this.loadFromStorage()}initialize(){this.initialized||(console.log("üè™ Initializing Monetization Framework"),this.loadSubscriptionStatus(),this.initializePremiumFeatures(),this.startUsageTracking(),this.initialized=!0,console.log(`‚úÖ Monetization Framework initialized - Tier: ${this.subscriptionTier}`))}loadSubscriptionStatus(){const e=localStorage.getItem("sp_sim_subscription");if(e)try{const t=JSON.parse(e);this.subscriptionTier=t.tier||"free",this.licenseInfo={...this.licenseInfo,...t.license},this.trials={...this.trials,...t.trials}}catch(t){console.warn("Failed to load subscription data:",t)}}saveSubscriptionStatus(){const e={tier:this.subscriptionTier,license:this.licenseInfo,trials:this.trials,lastUpdated:(new Date).toISOString()};localStorage.setItem("sp_sim_subscription",JSON.stringify(e))}initializePremiumFeatures(){switch(this.premiumFeatures.clear(),this.subscriptionTier){case"premium":this.premiumFeatures.add("advanced_analytics"),this.premiumFeatures.add("scenario_editor"),this.premiumFeatures.add("export_data"),this.premiumFeatures.add("unlimited_saves"),this.premiumFeatures.add("premium_scenarios");break;case"educational":this.premiumFeatures.add("classroom_mode"),this.premiumFeatures.add("student_progress_tracking"),this.premiumFeatures.add("curriculum_alignment"),this.premiumFeatures.add("assessment_tools"),this.premiumFeatures.add("bulk_licensing"),this.premiumFeatures.add("advanced_analytics"),this.premiumFeatures.add("export_data");break;case"enterprise":this.premiumFeatures.add("custom_scenarios"),this.premiumFeatures.add("branding_customization"),this.premiumFeatures.add("api_access"),this.premiumFeatures.add("priority_support"),this.premiumFeatures.add("advanced_reporting"),this.premiumFeatures.add("sso_integration"),this.premiumFeatures.add("unlimited_everything")}this.premiumFeatures.add("basic_gameplay"),this.premiumFeatures.add("basic_scenarios"),this.premiumFeatures.add("basic_saves")}hasFeature(e){return this.premiumFeatures.has(e)}useFeature(e,t={}){return this.hasFeature(e)?(this.trackFeatureUsage(e,t),{allowed:!0}):{allowed:!1,reason:"premium_required",feature:e,upgradePrompt:this.getUpgradePrompt(e)}}getUpgradePrompt(e){return{advanced_analytics:{title:"Advanced Analytics - Premium Feature",description:"Get detailed insights into your political performance with advanced charts, trend analysis, and comparative metrics.",benefits:["Detailed performance metrics","Historical trend analysis","Policy effectiveness tracking","Comparative benchmarks"]},scenario_editor:{title:"Scenario Editor - Premium Feature",description:"Create and share your own political scenarios and challenges.",benefits:["Custom scenario creation","Share with community","Import/export scenarios","Advanced event scripting"]},classroom_mode:{title:"Classroom Mode - Educational License",description:"Perfect for educators teaching political science, economics, and civics.",benefits:["Student progress tracking","Curriculum alignment","Assessment tools","Classroom management"]},unlimited_saves:{title:"Unlimited Saves - Premium Feature",description:"Save unlimited game states and create multiple political careers.",benefits:["Unlimited save slots","Cloud sync","Save organization","Backup & restore"]}}[e]||{title:"Premium Feature",description:"This feature requires a premium subscription.",benefits:["Enhanced gameplay","Advanced features","Priority support"]}}trackFeatureUsage(e,t={}){this.usageMetrics.featuresUsed.add(e),i.emit("monetization:feature_used",{feature:e,tier:this.subscriptionTier,context:t,timestamp:(new Date).toISOString()})}startUsageTracking(){this.usageMetrics.sessionsCount+=1,this.sessionStartTime=Date.now(),this.usageTrackingInterval=setInterval(()=>{this.saveUsageMetrics()},3e4)}saveUsageMetrics(){this.sessionStartTime&&(this.usageMetrics.totalPlayTime+=Date.now()-this.sessionStartTime,this.sessionStartTime=Date.now());const e={...this.usageMetrics,featuresUsed:Array.from(this.usageMetrics.featuresUsed),lastUpdated:(new Date).toISOString()};localStorage.setItem("sp_sim_usage_metrics",JSON.stringify(e))}loadFromStorage(){const e=localStorage.getItem("sp_sim_usage_metrics");if(e)try{const t=JSON.parse(e);this.usageMetrics={...this.usageMetrics,...t,featuresUsed:new Set(t.featuresUsed||[])}}catch(t){console.warn("Failed to load usage metrics:",t)}}checkSaveLimit(e){const t={free:3,premium:1/0,educational:1/0,enterprise:1/0},i=t[this.subscriptionTier]||t.free;return{allowed:e<i,limit:i,current:e}}getScenarioLimits(){const e={free:{basic:1/0,premium:0,custom:0,historical:3},premium:{basic:1/0,premium:1/0,custom:10,historical:1/0},educational:{basic:1/0,premium:1/0,custom:1/0,historical:1/0,curriculum:1/0},enterprise:{basic:1/0,premium:1/0,custom:1/0,historical:1/0,branded:1/0}};return e[this.subscriptionTier]||e.free}startTrial(e="premium"){return this.trials.premiumTrialUsed&&"premium"===e?{success:!1,reason:"trial_already_used"}:(this.trials.trialStartDate=(new Date).toISOString(),this.trials.trialEndDate=new Date(Date.now()+6048e5).toISOString(),"premium"===e&&(this.trials.premiumTrialUsed=!0,this.subscriptionTier="premium"),this.initializePremiumFeatures(),this.saveSubscriptionStatus(),i.emit("monetization:trial_started",{type:e,endDate:this.trials.trialEndDate}),{success:!0,endDate:this.trials.trialEndDate})}isTrialActive(){return!!this.trials.trialEndDate&&new Date<new Date(this.trials.trialEndDate)}upgrade(e,t={}){this.subscriptionTier=e,this.licenseInfo={...this.licenseInfo,...t},this.initializePremiumFeatures(),this.saveSubscriptionStatus(),i.emit("monetization:upgraded",{newTier:e,previousTier:this.subscriptionTier,features:Array.from(this.premiumFeatures)}),console.log(`üéâ Upgraded to ${e} tier`)}setupEventListeners(){i.on("game:scenario_completed",e=>{this.usageMetrics.scenariosCompleted+=1,this.trackFeatureUsage("scenario_completion",e.data)}),i.on("achievement:unlocked",e=>{this.usageMetrics.achievementsUnlocked+=1,this.trackFeatureUsage("achievement_unlock",e.data)}),i.on("game:save_attempt",e=>{const t=this.checkSaveLimit(e.data.currentSaveCount);t.allowed||i.emit("monetization:save_limit_reached",{limit:t.limit,current:t.current})}),window.addEventListener("beforeunload",()=>{this.saveUsageMetrics(),this.usageTrackingInterval&&clearInterval(this.usageTrackingInterval)})}getDashboardData(){return{tier:this.subscriptionTier,features:Array.from(this.premiumFeatures),usage:{...this.usageMetrics,featuresUsed:Array.from(this.usageMetrics.featuresUsed)},trial:{active:this.isTrialActive(),endDate:this.trials.trialEndDate},license:this.licenseInfo}}getRevenueAnalytics(){return{tier:this.subscriptionTier,retention:{sessions:this.usageMetrics.sessionsCount,totalTime:this.usageMetrics.totalPlayTime,averageSession:this.usageMetrics.totalPlayTime/Math.max(1,this.usageMetrics.sessionsCount)},engagement:{uniqueFeatures:this.usageMetrics.featuresUsed.size,scenariosCompleted:this.usageMetrics.scenariosCompleted,achievements:this.usageMetrics.achievementsUnlocked},conversion:{trialUsed:this.trials.premiumTrialUsed,trialActive:this.isTrialActive(),isPaying:"free"!==this.subscriptionTier}}}}),h=e("p",new class{constructor(){this.activePolicies=new Map,this.policyQueue=[],this.policyHistory=[],this.implementationCapacity=100,this.politicalCapitalCost=new Map,this.setupEventListeners()}initialize(){console.log("üèõÔ∏è Initializing Policy Implementation Engine"),this.loadPolicyState()}loadPolicyState(){const e=localStorage.getItem("sp_sim_policy_state");if(e)try{const t=JSON.parse(e);this.activePolicies=new Map(t.activePolicies||[]),this.policyQueue=t.policyQueue||[],this.policyHistory=t.policyHistory||[]}catch(t){console.warn("Failed to load policy state:",t)}}savePolicyState(){const e={activePolicies:Array.from(this.activePolicies.entries()),policyQueue:this.policyQueue,policyHistory:this.policyHistory,lastUpdated:(new Date).toISOString()};localStorage.setItem("sp_sim_policy_state",JSON.stringify(e))}implementPolicy(e,t){console.log(`üèõÔ∏è Implementing policy: ${e.name}`);const s=this.checkImplementationCapacity(e);if(!s.allowed)return{success:!1,reason:"capacity_exceeded",message:`Implementation capacity exceeded. ${s.message}`};const a=this.checkPoliticalRequirements(e,t);if(!a.allowed)return{success:!1,reason:"requirements_not_met",message:a.message};const n=this.checkMonetizationLimits(e);if(!n.allowed)return{success:!1,reason:"monetization_limit",message:n.message,upgradePrompt:n.upgradePrompt};const o=this.calculateImplementationTimeline(e,t),r={id:`${e.id}_${Date.now()}`,originalPolicy:e,startWeek:t.time.week,startYear:t.time.year,timeline:o,status:"implementing",progress:0,phases:this.createImplementationPhases(e),currentPhase:0,effects:{immediate:{},ongoing:{},final:{}},opposition:{resistance:this.calculateOppositionResistance(e,t),challenges:[]},costs:{financial:e.baseCost||0,political:this.calculatePoliticalCost(e,t),ongoing:0}};return this.activePolicies.set(r.id,r),this.applyImmediateEffects(r,t),this.notifyOpposition(r,t),this.trackPolicyImplementation(r),this.savePolicyState(),i.emit("policy:implementation_started",{policy:r,gameState:t}),console.log(`‚úÖ Policy implementation started: ${e.name}`),{success:!0,implementation:r,message:`Successfully started implementing ${e.name}`}}checkImplementationCapacity(e){const t=this.calculateCurrentCapacityLoad(),i=this.calculatePolicyLoad(e);return t+i>this.implementationCapacity?{allowed:!1,message:`Would exceed capacity (${t+i}/${this.implementationCapacity})`,currentLoad:t,policyLoad:i,available:this.implementationCapacity-t}:{allowed:!0,currentLoad:t,policyLoad:i}}calculateCurrentCapacityLoad(){let e=0;return Array.from(this.activePolicies.values()).forEach(t=>{e+=this.calculatePolicyLoad(t.originalPolicy)}),e}calculatePolicyLoad(e){const t={low:15,medium:25,high:40}[e.complexity]||25,i={economic:1.2,social:1,environmental:1.1,foreign:1.3}[e.category]||1;return Math.round(t*i)}checkPoliticalRequirements(e,t){const i=e.requirements||{},s=t.politics?.approval||0,a=this.calculateCoalitionSupport(t),n=[];return i.approval&&s<i.approval&&n.push(`Need ${i.approval}% approval (currently ${s.toFixed(1)}%)`),i.coalitionSupport&&a<i.coalitionSupport&&n.push(`Need ${i.coalitionSupport}% coalition support (currently ${a.toFixed(1)}%)`),n.length>0?{allowed:!1,message:`Political requirements not met: ${n.join(", ")}`,issues:n}:{allowed:!0}}calculateCoalitionSupport(e){return e.politics?.coalition?e.politics.coalition.reduce((e,t)=>e+(t.support||0),0):0}checkMonetizationLimits(e){if("high"===e.complexity&&"economic"===e.category){const e=m.useFeature("advanced_economic_policies");if(!e.allowed)return{allowed:!1,message:"Advanced economic policies require premium subscription",upgradePrompt:e.upgradePrompt}}const t=this.activePolicies.size,i={free:3,premium:10,educational:15,enterprise:1/0},s=i[m.subscriptionTier]||i.free;return t>=s?{allowed:!1,message:`Policy limit reached (${t}/${s})`,upgradePrompt:m.getUpgradePrompt("unlimited_policies")}:{allowed:!0}}calculateImplementationTimeline(e,t){const i=e.duration||12,s={low:.8,medium:1,high:1.3},a=1+this.calculateOppositionResistance(e,t)/100,n=Math.max(.7,(t.politics?.approval||50)/100);return{planned:i,estimated:Math.round(i*(s[e.complexity]||1)*a*(1/n)),factors:{complexity:s[e.complexity]||1,opposition:a,approval:n}}}calculateOppositionResistance(e,t){let i=0;i+={economic:20,social:30,environmental:25,foreign:35}[e.category]||20,i+=.4*((t.politics?.opposition?.strength||50)-50);const s=(e.baseCost||0)/1e9;return i+=Math.min(20,10*s),Math.max(0,Math.min(100,i))}calculatePoliticalCost(e,t){const i=(e.baseCost||0)/1e8,s=1+this.calculateOppositionResistance(e,t)/200;return Math.round(i*({low:1,medium:1.5,high:2}[e.complexity]||1)*s)}createImplementationPhases(e){return[{name:"Planning & Preparation",duration:.2,description:"Developing implementation strategy and preparing resources",effects:"minimal"},{name:"Initial Implementation",duration:.3,description:"Beginning policy rollout and initial changes",effects:"moderate"},{name:"Full Deployment",duration:.4,description:"Complete policy implementation across all affected areas",effects:"significant"},{name:"Stabilization",duration:.1,description:"Monitoring effects and making final adjustments",effects:"full"}]}applyImmediateEffects(e,t){const s=e.originalPolicy,a={};s.effects&&Object.entries(s.effects).forEach(([e,t])=>{"object"==typeof t&&void 0!==t.min?a[e]=.2*t.min:"number"==typeof t&&(a[e]=.2*t)}),e.effects.immediate=a,i.emit("policy:immediate_effects",{policy:e,effects:a,gameState:t})}notifyOpposition(e,t){i.emit("opposition:policy_notification",{policy:e,resistance:e.opposition.resistance,gameState:t})}trackPolicyImplementation(e){m.trackFeatureUsage("policy_implementation",{category:e.originalPolicy.category,complexity:e.originalPolicy.complexity,cost:e.costs.financial,politicalCost:e.costs.political}),i.emit("analytics:policy_implemented",{policy:e.originalPolicy,implementation:{timeline:e.timeline,costs:e.costs,opposition:e.opposition.resistance}})}updateImplementations(e){const t=[];Array.from(this.activePolicies.entries()).forEach(([i,s])=>{const a=this.updatePolicyProgress(s,e);a.completed&&(t.push(s),this.activePolicies.delete(i),this.policyHistory.push({...s,completedWeek:e.time.week,completedYear:e.time.year,finalEffects:a.effects}))}),t.forEach(t=>{this.handlePolicyCompletion(t,e)}),this.savePolicyState()}updatePolicyProgress(e,t){const i=this.calculateWeeksSince(e.startWeek,e.startYear,t.time.week,t.time.year),s=e.timeline.estimated,a=Math.min(100,i/s*100),n=a-e.progress;e.progress=a;const o=this.updateCurrentPhase(e),r=this.calculateOngoingEffects(e,n);this.handleOppositionChallenges(e,t);const c=e.progress>=100;return c&&console.log(`‚úÖ Policy implementation completed: ${e.originalPolicy.name}`),{completed:c,progress:e.progress,phase:o,effects:r}}calculateWeeksSince(e,t,i,s){return 52*(s-t)+(i-e)}updateCurrentPhase(e){const{phases:t}=e;let s=0;for(let a=0;a<t.length;a+=1)if(s+=100*t[a].duration,e.progress<=s){e.currentPhase!==a&&(e.currentPhase=a,i.emit("policy:phase_change",{policy:e,newPhase:a,phaseName:t[a].name}));break}return e.currentPhase}calculateOngoingEffects(e,t){const s=e.originalPolicy,a={};return s.effects&&t>0&&Object.entries(s.effects).forEach(([i,s])=>{let n=0;if("object"==typeof s&&void 0!==s.min){const i=e.progress/100;n=s.min+(s.max-s.min)*i,n*=t/100}else"number"==typeof s&&(n=s*(t/100));0!==n&&(a[i]=n)}),Object.keys(a).length>0&&i.emit("policy:ongoing_effects",{policy:e,effects:a}),a}handleOppositionChallenges(e,t){const s=e.opposition.resistance/200;if(Math.random()<s){const s=this.generateOppositionChallenge(e,t);e.opposition.challenges.push(s),i.emit("policy:opposition_challenge",{policy:e,challenge:s,gameState:t})}}generateOppositionChallenge(e,t){const i=["parliamentary_question","media_campaign","legal_challenge","public_protest","coalition_pressure"],s=i[Math.floor(Math.random()*i.length)];return{id:`challenge_${Date.now()}`,type:s,severity:Math.floor(3*Math.random())+1,description:this.getChallengeDescription(s,e),week:t.time.week,year:t.time.year,resolved:!1}}getChallengeDescription(e,t){const i=t.originalPolicy.name;return{parliamentary_question:`Opposition demands parliamentary answers about ${i} implementation`,media_campaign:`Media campaign criticizing the effectiveness of ${i}`,legal_challenge:`Legal challenge filed against ${i} on constitutional grounds`,public_protest:`Public protests organized against ${i}`,coalition_pressure:`Coalition partners express concerns about ${i}`}[e]||`Opposition challenge to ${i}`}handlePolicyCompletion(e,t){const s=this.calculateFinalEffects(e);i.emit("policy:completed",{policy:e,finalEffects:s,gameState:t}),console.log(`üéâ Policy successfully implemented: ${e.originalPolicy.name}`)}calculateFinalEffects(e){const t=e.originalPolicy,i={};return t.effects&&Object.entries(t.effects).forEach(([e,t])=>{"object"==typeof t&&void 0!==t.min?i[e]=t.max:"number"==typeof t&&(i[e]=t)}),i}getActivePolicies(){return Array.from(this.activePolicies.values()).map(e=>({id:e.id,name:e.originalPolicy.name,category:e.originalPolicy.category,progress:e.progress,currentPhase:e.phases[e.currentPhase],timeRemaining:this.calculateTimeRemaining(e),opposition:e.opposition.resistance}))}calculateTimeRemaining(e){const t=e.timeline.estimated,i=t*(e.progress/100);return Math.max(0,t-i)}getCapacityStatus(){const e=this.calculateCurrentCapacityLoad();return{used:e,total:this.implementationCapacity,available:this.implementationCapacity-e,percentage:e/this.implementationCapacity*100}}setupEventListeners(){i.on("policy:implement",e=>{const{policy:t,gameState:s}=e.data,a=this.implementPolicy(t,s);a.success?i.emit("policy:implemented",{policy:a.implementation,gameState:s}):i.emit("policy:rejected",{policy:t,reason:a.reason,message:a.message,upgradePrompt:a.upgradePrompt})}),i.on("game:state_updated",e=>{this.updateImplementations(e.data.gameState)}),window.addEventListener("beforeunload",()=>{this.savePolicyState()})}}),d=new class{constructor(){this.eventSystem=i,this.activeCrises=[],this.resolvedCrises=[],this.crisisHistory=[],this.escalationFactors={mediaAttention:.2,publicConcern:.3,oppositionFocus:.15,managementQuality:.35},this.crisisTemplates={economic:{baseEscalation:.05,economicImpact:.3,approvalImpact:.2,baseMediaAttraction:.6,typicalDuration:[3,8],possibleEscalations:["political","international"],responseOptions:[{id:"stimulus",name:"Economic Stimulus",cost:.8,effectiveness:.7},{id:"austerity",name:"Austerity Measures",cost:.3,effectiveness:.4},{id:"reform",name:"Structural Reform",cost:.6,effectiveness:.9},{id:"ignore",name:"Minimal Response",cost:.1,effectiveness:.1}]},political:{baseEscalation:.1,economicImpact:.1,approvalImpact:.4,baseMediaAttraction:.8,typicalDuration:[2,6],possibleEscalations:["economic","scandal"],responseOptions:[{id:"reshuffle",name:"Cabinet Reshuffle",cost:.5,effectiveness:.6},{id:"address",name:"Public Address",cost:.2,effectiveness:.4},{id:"investigation",name:"Independent Investigation",cost:.4,effectiveness:.8},{id:"deflect",name:"Deflect Blame",cost:.1,effectiveness:.2}]},scandal:{baseEscalation:.15,economicImpact:.05,approvalImpact:.5,baseMediaAttraction:.9,typicalDuration:[3,10],possibleEscalations:["political"],responseOptions:[{id:"resignation",name:"Demand Resignation",cost:.7,effectiveness:.9},{id:"defend",name:"Defend Official",cost:.3,effectiveness:.3},{id:"damage_control",name:"Damage Control PR",cost:.5,effectiveness:.6},{id:"scapegoat",name:"Find Scapegoat",cost:.4,effectiveness:.5}]},international:{baseEscalation:.07,economicImpact:.25,approvalImpact:.15,baseMediaAttraction:.5,typicalDuration:[4,12],possibleEscalations:["economic","security"],responseOptions:[{id:"diplomacy",name:"Diplomatic Solution",cost:.3,effectiveness:.7},{id:"sanctions",name:"Economic Sanctions",cost:.6,effectiveness:.5},{id:"military",name:"Military Response",cost:.9,effectiveness:.8},{id:"isolate",name:"Isolate the Issue",cost:.2,effectiveness:.3}]},security:{baseEscalation:.12,economicImpact:.15,approvalImpact:.3,baseMediaAttraction:.7,typicalDuration:[2,8],possibleEscalations:["political","international"],responseOptions:[{id:"emergency",name:"Emergency Measures",cost:.8,effectiveness:.9},{id:"investigation",name:"Security Investigation",cost:.5,effectiveness:.7},{id:"reassurance",name:"Public Reassurance",cost:.2,effectiveness:.4},{id:"coordination",name:"Inter-agency Coordination",cost:.6,effectiveness:.8}]},natural:{baseEscalation:.2,economicImpact:.35,approvalImpact:.1,baseMediaAttraction:.6,typicalDuration:[1,5],possibleEscalations:["economic"],responseOptions:[{id:"emergency_relief",name:"Emergency Relief",cost:.7,effectiveness:.9},{id:"reconstruction",name:"Reconstruction Plan",cost:.9,effectiveness:.8},{id:"preventive",name:"Preventive Measures",cost:.5,effectiveness:.6},{id:"minimal",name:"Minimal Response",cost:.1,effectiveness:.2}]}},this.setupEventListeners()}setupEventListeners(){this.eventSystem.on("turn:end",e=>{this.processCrisesTurn(e.data.gameState)}),this.eventSystem.on("crisis:generate",e=>{this.generateCrisis(e.data)}),this.eventSystem.on("crisis:respond",e=>{this.respondToCrisis(e.data)})}processCrisesTurn(e){this.activeCrises.forEach(t=>{this.updateCrisisState(t,e),this.applyCrisisEffects(t,e),t.managementScore>=100?this.resolveCrisis(t,e):t.severity>=90&&!t.hasEscalated&&this.escalateCrisis(t,e)}),this.checkForNewCrises(e),this.updateCrisisHistory(e)}updateCrisisState(e,t){const i=this.crisisTemplates[e.type],s=e.mediaAttention/100*this.escalationFactors.mediaAttention,a=e.publicConcern/100*this.escalationFactors.publicConcern,n=(t.politics.approval<50?.2:.1)*this.escalationFactors.oppositionFocus,o=e.managementScore/100*this.escalationFactors.managementQuality,r=i.baseEscalation+s+a+n-o;e.severity=Math.max(0,Math.min(100,e.severity+10*r)),e.currentWeek++,e.totalDuration++;const c=e.severity/100*i.baseMediaAttraction-e.mediaAttention/100+.1*(Math.random()-.5);e.mediaAttention=Math.max(0,Math.min(100,e.mediaAttention+10*c));const l=.1*(e.mediaAttention-e.publicConcern)+.05*(Math.random()-.5);e.publicConcern=Math.max(0,Math.min(100,e.publicConcern+10*l)),Math.random()<.1&&this.generateCrisisDevelopment(e,t),e.activeResponses.length>0&&e.activeResponses.forEach(e=>{e.weeksActive++,e.currentEffectiveness=e.baseEffectiveness*Math.max(.3,1-.1*e.weeksActive)})}applyCrisisEffects(e,t){const i=this.crisisTemplates[e.type],s=e.severity/100,a=i.economicImpact*s*.1;t.economy.gdpGrowth-=a;const n=i.approvalImpact*s*.5;switch(t.politics.approval-=n,e.type){case"economic":t.economy.unemployment+=.5*a,t.economy.confidence-=2*s;break;case"political":t.politics.coalitionStability-=1.5*s;break;case"security":t.politics.approval-=.3*s;break;case"natural":1===e.currentWeek&&(t.economy.gdpGrowth-=.5*s)}}generateCrisis(e){const t=this.crisisTemplates[e.type],i={id:this.generateCrisisId(),type:e.type,title:e.title,description:e.description,severity:e.initialSeverity||40*Math.random()+20,mediaAttention:50*t.baseMediaAttraction+30*Math.random(),publicConcern:30*Math.random()+10,managementScore:0,currentWeek:0,totalDuration:0,hasEscalated:!1,activeResponses:[],developments:[],responseHistory:[],createdAt:Date.now(),economicDamage:0,politicalDamage:0,longTermEffects:[],origin:e.origin||"random",affectedRegions:e.affectedRegions||[],stakeholders:e.stakeholders||[]};return this.activeCrises.push(i),this.eventSystem.emit("crisis:generated",{crisis:i,template:t}),i}respondToCrisis(e){const{crisisId:t,responseId:i,customParameters:s}=e,a=this.activeCrises.find(e=>e.id===t);if(!a)return!1;const n=this.crisisTemplates[a.type].responseOptions.find(e=>e.id===i);if(!n)return!1;const o=n.effectiveness,r=this.calculateTimingFactor(a),c=s?.resources||1,l=o*r*c*this.calculatePublicSupportFactor(a,e.gameState),p={id:n.id,name:n.name,cost:n.cost*c,baseEffectiveness:o,currentEffectiveness:l,implementedAt:a.currentWeek,weeksActive:0,parameters:s||{}};return a.activeResponses.push(p),a.responseHistory.push(p),a.managementScore+=20*l,a.managementScore=Math.min(100,a.managementScore),this.applyResponseCosts(p,e.gameState),this.generateResponseOutcome(a,p,e.gameState),this.eventSystem.emit("crisis:response_implemented",{crisis:a,response:p,effectiveness:l}),!0}calculateTimingFactor(e){return e.currentWeek<=1?1.2:e.currentWeek<=3?1:e.currentWeek<=6?.8:.6}calculatePublicSupportFactor(e,t){return(t.politics.approval/100+Math.max(.3,1-e.publicConcern/200))/2}applyResponseCosts(e,t){const i=10*e.cost;if(t.politics.politicalCapital=Math.max(0,t.politics.politicalCapital-i),e.cost>.5){const i=.1*(e.cost-.5);t.economy.governmentDebt+=i}}generateResponseOutcome(e,t,i){this.generateResponseOutcomes(e,t).forEach(t=>{e.developments.push({week:e.currentWeek,type:"response_outcome",title:t.title,description:t.description,impact:t.impact}),this.applyOutcomeEffects(t,i)})}generateResponseOutcomes(e,t){const i=[],s=t.currentEffectiveness;return s>.8?i.push({title:"Highly Effective Response",description:`The ${t.name} strategy has proven highly effective in addressing the crisis.`,impact:{approval:2,severity:-15,mediaAttention:-10}}):s>.6?i.push({title:"Moderately Effective Response",description:`The ${t.name} strategy has shown moderate success.`,impact:{approval:1,severity:-8,mediaAttention:-5}}):s>.3?i.push({title:"Limited Response Success",description:`The ${t.name} strategy has had limited impact on the crisis.`,impact:{approval:0,severity:-3,mediaAttention:0}}):i.push({title:"Response Proves Ineffective",description:`The ${t.name} strategy has failed to address the crisis effectively.`,impact:{approval:-1,severity:2,mediaAttention:5}}),i}applyOutcomeEffects(e,t){e.impact.approval&&(t.politics.approval+=e.impact.approval)}checkForNewCrises(e){let t=.05;e.economy.gdpGrowth<0&&(t+=.03),e.economy.unemployment>8&&(t+=.02),e.politics.approval<40&&(t+=.02),this.activeCrises.length>0&&(t+=.01),this.activeCrises.length>2&&(t*=.5),Math.random()<t&&this.generateRandomCrisis(e)}generateRandomCrisis(e){const t=Object.keys(this.crisisTemplates),i=this.calculateCrisisTypeWeights(e),s=this.weightedRandomSelect(t,i),a=this.generateCrisisData(s,e);this.generateCrisis(a)}calculateCrisisTypeWeights(e){return{economic:e.economy.gdpGrowth<1?.3:.15,political:e.politics.approval<50?.25:.15,scandal:.2*Math.random(),international:.15,security:.1,natural:.1}}weightedRandomSelect(e,t){const i=Object.values(t).reduce((e,t)=>e+t,0);let s=Math.random()*i;for(let a=0;a<e.length;a++)if(s-=t[e[a]],s<=0)return e[a];return e[e.length-1]}generateCrisisData(e,t){const i={economic:[{title:"Market Volatility Crisis",description:"Sudden market fluctuations threaten economic stability.",initialSeverity:35},{title:"Banking Sector Concerns",description:"Major banks face liquidity issues causing market concern.",initialSeverity:45}],political:[{title:"Coalition Tensions",description:"Internal disagreements threaten government stability.",initialSeverity:30},{title:"Opposition Challenge",description:"Opposition parties unite to challenge key policies.",initialSeverity:25}],scandal:[{title:"Ethics Investigation",description:"Senior official under investigation for potential misconduct.",initialSeverity:40}]}[e]||[],s=i[Math.floor(Math.random()*i.length)];return{type:e,title:s.title,description:s.description,initialSeverity:s.initialSeverity+10*(Math.random()-.5),origin:"random"}}generateCrisisId(){return`crisis_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}resolveCrisis(e,t){const i=this.activeCrises.indexOf(e);i>-1&&this.activeCrises.splice(i,1),e.resolvedAt=Date.now(),e.finalSeverity=e.severity,e.resolutionMethod="management_success",this.resolvedCrises.push(e),t.politics.approval+=3,t.politics.politicalCapital+=5,this.eventSystem.emit("crisis:resolved",{crisis:e,method:"management_success"})}escalateCrisis(e,t){const i=this.crisisTemplates[e.type],{possibleEscalations:s}=i;if(s.length>0){const t=s[Math.floor(Math.random()*s.length)],i=this.generateCrisis({type:t,title:`Escalated: ${e.title}`,description:`The ${e.title} has escalated into a broader ${t} crisis.`,initialSeverity:Math.min(80,e.severity+20),origin:"escalation",parentCrisis:e.id});e.hasEscalated=!0,e.escalatedTo=i.id,this.eventSystem.emit("crisis:escalated",{originalCrisis:e,escalatedCrisis:i})}}generateCrisisDevelopment(e,t){const i=[{title:"New Information Emerges",description:"Additional details about the crisis have come to light.",impact:{severity:5,mediaAttention:10}},{title:"Stakeholder Concerns",description:"Key stakeholders express growing concern about the situation.",impact:{publicConcern:8,severity:3}},{title:"Opposition Criticism",description:"Opposition parties criticize the government's handling of the crisis.",impact:{mediaAttention:8,publicConcern:5}}],s=i[Math.floor(Math.random()*i.length)];e.developments.push({week:e.currentWeek,type:"development",title:s.title,description:s.description,impact:s.impact}),Object.keys(s.impact).forEach(t=>{Object.prototype.hasOwnProperty.call(e,t)&&(e[t]=Math.min(100,e[t]+s.impact[t]))})}updateCrisisHistory(e){const t={week:e.time.week,year:e.time.year,activeCrises:this.activeCrises.length,totalSeverity:this.activeCrises.reduce((e,t)=>e+t.severity,0),crisisTypes:this.activeCrises.reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{})};this.crisisHistory.push(t),this.crisisHistory.length>104&&this.crisisHistory.shift()}getCrisisOverview(){return{active:this.activeCrises,resolved:this.resolvedCrises,history:this.crisisHistory,totalActiveSeverity:this.activeCrises.reduce((e,t)=>e+t.severity,0),averageDuration:this.resolvedCrises.length>0?this.resolvedCrises.reduce((e,t)=>e+t.totalDuration,0)/this.resolvedCrises.length:0}}},u=new class{constructor(){this.eventSystem=i,this.countries=this.initializeCountries(),this.relationships={},this.tradeAgreements=[],this.treaties=[],this.sanctions=[],this.conflicts=[],this.globalEvents=[],this.diplomaticHistory=[],this.globalEconomy={growth:2.5,tradeVolume:100,oilPrice:75,commodityPrices:{},currencyRates:{},globalInflation:2.2},this.organizations={UN:{membership:!0,influence:.8,standing:"good"},NATO:{membership:!1,influence:0,standing:"neutral"},EU:{membership:!1,influence:0,standing:"neutral"},WTO:{membership:!0,influence:.6,standing:"good"},G7:{membership:!1,influence:0,standing:"neutral"},G20:{membership:!0,influence:.7,standing:"good"}},this.setupEventListeners()}initializeCountries(){return{USA:{name:"United States",economicPower:95,militaryPower:100,diplomaticInfluence:90,politicalSystem:"democracy",region:"North America",gdp:21e12,population:33e7,tradeImportance:85},CHN:{name:"China",economicPower:85,militaryPower:80,diplomaticInfluence:75,politicalSystem:"authoritarian",region:"East Asia",gdp:14e12,population:14e8,tradeImportance:90},DEU:{name:"Germany",economicPower:70,militaryPower:45,diplomaticInfluence:80,politicalSystem:"democracy",region:"Europe",gdp:4e12,population:83e6,tradeImportance:95},GBR:{name:"United Kingdom",economicPower:65,militaryPower:60,diplomaticInfluence:85,politicalSystem:"democracy",region:"Europe",gdp:31e11,population:67e6,tradeImportance:80},JPN:{name:"Japan",economicPower:75,militaryPower:50,diplomaticInfluence:70,politicalSystem:"democracy",region:"East Asia",gdp:5e12,population:126e6,tradeImportance:85},RUS:{name:"Russia",economicPower:45,militaryPower:85,diplomaticInfluence:60,politicalSystem:"authoritarian",region:"Europe/Asia",gdp:17e11,population:146e6,tradeImportance:70},IND:{name:"India",economicPower:55,militaryPower:70,diplomaticInfluence:65,politicalSystem:"democracy",region:"South Asia",gdp:32e11,population:138e7,tradeImportance:75},FRA:{name:"France",economicPower:60,militaryPower:55,diplomaticInfluence:75,politicalSystem:"democracy",region:"Europe",gdp:29e11,population:67e6,tradeImportance:85},BRA:{name:"Brazil",economicPower:40,militaryPower:35,diplomaticInfluence:50,politicalSystem:"democracy",region:"South America",gdp:21e11,population:212e6,tradeImportance:60},CAN:{name:"Canada",economicPower:50,militaryPower:30,diplomaticInfluence:60,politicalSystem:"democracy",region:"North America",gdp:18e11,population:38e6,tradeImportance:85}}}setupEventListeners(){this.eventSystem.on("turn:end",e=>{this.processInternationalTurn(e.data.gameState)}),this.eventSystem.on("diplomatic:action",e=>{this.processDiplomaticAction(e.data)}),this.eventSystem.on("trade:negotiate",e=>{this.negotiateTradeAgreement(e.data)})}processInternationalTurn(e){this.updateDiplomaticRelations(e),this.processTrade(e),this.processInternationalOrganizations(e),this.checkForInternationalCrises(e),this.processConflicts(e),this.updateGlobalEconomy(e),this.eventSystem.emit("international:update",{relationships:this.relationships,globalEconomy:this.globalEconomy,activeEvents:this.globalEvents})}updateDiplomaticRelations(e){Object.keys(this.countries).forEach(t=>{this.relationships[t]||(this.relationships[t]=this.calculateInitialRelation(t,e));let i=0;const s=this.relationships[t];i+=this.tradeAgreements.some(e=>e.country===t)?.1:0,i+=.1*(this.calculateIdeologyAlignment(e,t)-.5),i+=this.treaties.some(e=>e.country===t&&"military"===e.type)?.1:0,i+=this.sanctions.some(e=>e.target===t)?-.3:0,i+=this.getRecentDiplomaticIncidents(e,t).effect,i+=this.calculateCommonEnemiesEffect(e,t),i+=.05*this.calculateTradeInterdependence(t,e),i+=.02*(this.calculateRegionalStability(this.countries[t].region)-.5),i+=.01*(50-s),i+=.2*(Math.random()-.5),this.relationships[t]=Math.max(0,Math.min(100,s+i)),this.trackRelationHistory(t,e,i)})}calculateInitialRelation(e,t){const i=this.countries[e];let s=50;return i.politicalSystem===t.country.politicalSystem?s+=10:"democracy"===i.politicalSystem!=("democracy"===t.country.politicalSystem)&&(s-=5),s+=10*(1-Math.abs(i.economicPower-t.country.economicPower)/100),i.region===t.country.region&&(s+=15),s+=this.getHistoricalRelationshipFactor(e),Math.max(0,Math.min(100,s+20*(Math.random()-.5)))}calculateIdeologyAlignment(e,t){let i=.5;return this.countries[t].politicalSystem===e.country.politicalSystem&&(i+=.3),i+=.2*this.calculateEconomicPolicyAlignment(e,t),Math.max(0,Math.min(1,i))}calculateEconomicPolicyAlignment(e,t){return.5+.4*(Math.random()-.5)}getRecentDiplomaticIncidents(e,t){const i=this.diplomaticHistory.filter(i=>i.country===t&&e.time.week-i.week<=12);let s=0;return i.forEach(t=>{const i=1-(e.time.week-t.week)/12;s+=t.effect*i}),{effect:s}}calculateCommonEnemiesEffect(e,t){let i=0;return Object.keys(this.relationships).forEach(e=>{if(e!==t){const s=this.relationships[e],a=this.getCountryRelation(t,e);s<40&&a<40&&(i+=.02)}}),i}calculateTradeInterdependence(e,t){const i=this.countries[e],s=this.tradeAgreements.find(t=>t.country===e);if(!s)return 0;const a=s.volume||1e9;return(a/t.economy.gdp+a/i.gdp)/2}calculateRegionalStability(e){return{"North America":.8,Europe:.7,"East Asia":.6,"South Asia":.5,"Middle East":.3,Africa:.4,"South America":.6}[e]||.5}trackRelationHistory(e,t,i){this.diplomaticHistory.push({week:t.time.week,year:t.time.year,country:e,event:"relation_change",effect:i,newValue:this.relationships[e]}),this.diplomaticHistory.length>1e3&&(this.diplomaticHistory=this.diplomaticHistory.slice(-1e3))}processTrade(e){this.tradeAgreements.forEach(t=>{const i=t.economicBenefit||.02;e.economy.gdpGrowth+=i/52,this.relationships[t.country]&&(this.relationships[t.country]+=.05),Math.random()<.01&&this.generateTradeDispute(t,e)})}generateTradeDispute(e,t){const i={id:`trade_dispute_${Date.now()}`,country:e.country,type:"trade_dispute",severity:30*Math.random()+10,description:`Trade dispute with ${this.countries[e.country].name} over ${this.getRandomTradeIssue()}`,economicImpact:-.01*Math.random(),startWeek:t.time.week};this.globalEvents.push(i),this.relationships[e.country]-=5,t.economy.gdpGrowth+=i.economicImpact,this.eventSystem.emit("international:trade_dispute",{dispute:i,agreement:e})}getRandomTradeIssue(){const e=["tariff regulations","intellectual property rights","agricultural subsidies","manufacturing standards","currency manipulation concerns","dumping allegations","import quotas","environmental standards"];return e[Math.floor(Math.random()*e.length)]}processInternationalOrganizations(e){Object.keys(this.organizations).forEach(t=>{const i=this.organizations[t];i.membership&&(e.country.diplomaticInfluence+=.01*i.influence,e.economy.governmentSpending+=1e-4,Math.random()<.02&&this.generateOrganizationEvent(t,e))})}generateOrganizationEvent(e,t){const i={UN:[{type:"resolution",description:"UN Security Council resolution requires your position"},{type:"peacekeeping",description:"UN peacekeeping mission requests contribution"}],WTO:[{type:"ruling",description:"WTO ruling affects your trade policies"},{type:"negotiation",description:"New trade round negotiations begin"}],G20:[{type:"summit",description:"G20 summit addresses global economic issues"},{type:"coordination",description:"Coordinated economic policy response proposed"}]}[e]||[];if(i.length>0){const s=i[Math.floor(Math.random()*i.length)];this.globalEvents.push({id:`org_event_${Date.now()}`,organization:e,type:s.type,description:s.description,startWeek:t.time.week,requiresResponse:!0}),this.eventSystem.emit("international:organization_event",{organization:e,event:s})}}checkForInternationalCrises(e){Math.random()<.03&&this.generateInternationalCrisis(e)}generateInternationalCrisis(e){const t=[{type:"regional_conflict",description:"Regional conflict threatens international stability",severity:40*Math.random()+30,economicImpact:-.005,diplomaticImpact:-2},{type:"trade_war",description:"Major trade war between global powers",severity:50*Math.random()+25,economicImpact:-.01,diplomaticImpact:-1},{type:"humanitarian_crisis",description:"Humanitarian crisis requires international response",severity:60*Math.random()+20,economicImpact:-.002,diplomaticImpact:1}],i=t[Math.floor(Math.random()*t.length)];i.id=`intl_crisis_${Date.now()}`,i.startWeek=e.time.week,this.globalEvents.push(i),e.economy.gdpGrowth+=i.economicImpact,e.country.diplomaticInfluence+=i.diplomaticImpact,this.eventSystem.emit("international:crisis",{crisis:i})}processConflicts(e){this.conflicts.forEach(t=>{t.duration++,e.economy.gdpGrowth-=t.economicDrain||.001,e.politics.approval-=t.approvalDrain||.1,Math.random()<.05&&(Math.random()<.3?this.escalateConflict(t,e):this.resolveConflict(t,e))})}updateGlobalEconomy(e){this.globalEconomy.growth+=.1*(Math.random()-.5),this.globalEconomy.growth=Math.max(-2,Math.min(5,this.globalEconomy.growth)),this.globalEconomy.oilPrice+=5*(Math.random()-.5),this.globalEconomy.oilPrice=Math.max(30,Math.min(150,this.globalEconomy.oilPrice)),this.globalEconomy.tradeVolume+=this.globalEconomy.growth/100*2;const t=.1*this.globalEconomy.growth;e.economy.gdpGrowth+=t/52}negotiateTradeAgreement(e){const{countryCode:t,terms:i,gameState:s}=e,a=this.countries[t];if(!a)return!1;const n=this.relationships[t]/100,o=this.calculateMutualEconomicBenefit(t,s),r=(n+o+(s.politics.approval/100*.5+.5))/3;if(Math.random()<r){const e={id:`trade_${t}_${Date.now()}`,country:t,type:i.type||"bilateral_trade",economicBenefit:.02*o,volume:this.calculateTradeVolume(t,s),negotiatedWeek:s.time.week,terms:i};return this.tradeAgreements.push(e),this.relationships[t]+=10,this.diplomaticHistory.push({week:s.time.week,year:s.time.year,country:t,event:"trade_agreement_signed",effect:10,details:e}),this.eventSystem.emit("international:trade_agreement_success",{agreement:e,country:a}),!0}return this.relationships[t]-=2,this.diplomaticHistory.push({week:s.time.week,year:s.time.year,country:t,event:"trade_negotiation_failed",effect:-2}),this.eventSystem.emit("international:trade_agreement_failed",{countryCode:t,country:a}),!1}calculateMutualEconomicBenefit(e,t){const i=this.countries[e];return(1-Math.abs(i.economicPower-t.country.economicPower)/100+i.tradeImportance/100)/2}calculateTradeVolume(e,t){const i=this.countries[e];return.001*Math.min(t.economy.gdp,i.gdp)*(this.relationships[e]/100)}getCountryRelation(e,t){return 50+40*(Math.random()-.5)}getHistoricalRelationshipFactor(e){return{USA:5,GBR:10,CAN:15,DEU:5,FRA:5,CHN:-5,RUS:-10}[e]||0}escalateConflict(e,t){e.severity+=10,e.economicDrain=1.5*(e.economicDrain||.001),e.approvalDrain=1.3*(e.approvalDrain||.1),this.eventSystem.emit("international:conflict_escalated",{conflict:e})}resolveConflict(e,t){const i=this.conflicts.indexOf(e);i>-1&&this.conflicts.splice(i,1),t.politics.approval+=2,t.country.diplomaticInfluence+=1,this.eventSystem.emit("international:conflict_resolved",{conflict:e})}getInternationalOverview(){return{relationships:this.relationships,tradeAgreements:this.tradeAgreements,globalEconomy:this.globalEconomy,organizations:this.organizations,activeEvents:this.globalEvents,conflicts:this.conflicts}}};e("g",new class{constructor(){this.eventSystem=i,this.saveSystem=s,this.economicSimulation=a,this.politicalSystem=n,this.politicalEvents=o,this.winConditions=r,this.gameReset=c,this.aiOpposition=l,this.monetizationFramework=m,this.policyImplementationEngine=h,this.crisisManagementSystem=d,this.internationalRelationsSystem=u,this.gameState=this.createInitialGameState(),this.isRunning=!1,this.isPaused=!1,this.gameSpeed=1e3,this.baseGameSpeed=1e3,this.effectiveGameSpeed=1e3,this.lastUpdateTime=0,this.gameLoopId=null,this.frameCount=0,this.lastFrameTime=Date.now(),this.fps=0,this.performanceMetrics=[],this.turnProcessingTimes=[],this.simulationDepth={economic:"detailed",political:"detailed",international:"standard",crisis:"detailed",demographics:"standard"},this.initializeEventListeners()}initialize(){console.log("Initializing SP_Sim Game Engine..."),this.monetizationFramework.initialize(),this.policyImplementationEngine.initialize();const e=parseInt(localStorage.getItem("sp_sim_game_speed"),10);Number.isNaN(e)||this.setGameSpeed(e);const i=this.saveSystem.loadAutoSave();i&&(this.gameState=i,console.log("Auto-save loaded")),this.eventSystem.emit(t.GAME_START,{gameState:this.gameState}),console.log("Game Engine initialized successfully")}start(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastUpdateTime=Date.now(),this.gameLoop(),this.eventSystem.emit(t.GAME_RESUME,{gameState:this.gameState}),console.log("Game started"))}pause(){this.isRunning&&!this.isPaused&&(this.isPaused=!0,this.gameLoopId&&(clearTimeout(this.gameLoopId),this.gameLoopId=null),this.eventSystem.emit(t.GAME_PAUSE,{gameState:this.gameState}),console.log("Game paused"))}resume(){this.isRunning&&this.isPaused&&(this.isPaused=!1,this.lastUpdateTime=Date.now(),this.gameLoop(),this.eventSystem.emit(t.GAME_RESUME,{gameState:this.gameState}),console.log("Game resumed"))}stop(){this.isRunning=!1,this.isPaused=!1,this.gameLoopId&&(clearTimeout(this.gameLoopId),this.gameLoopId=null),this.autoSave(),console.log("Game stopped")}nextTurn(){this.isRunning&&this.processTurn()}gameLoop(){if(!this.isRunning||this.isPaused)return;const e=Date.now(),t=e-this.lastUpdateTime;if(this.updateFPS(e),t>=this.effectiveGameSpeed){const t=performance.now();this.processTurn();const i=performance.now()-t;this.turnProcessingTimes.push(i),this.turnProcessingTimes.length>20&&this.turnProcessingTimes.shift();const s=this.turnProcessingTimes.reduce((e,t)=>e+t,0)/this.turnProcessingTimes.length,a=Math.max(this.baseGameSpeed,1.5*s);this.effectiveGameSpeed=Math.max(a,this.gameSpeed),this.lastUpdateTime=e,this.performanceMetrics.push({turn:this.gameState.time.week,year:this.gameState.time.year,processingTime:i,effectiveSpeed:this.effectiveGameSpeed,avgProcessingTime:s}),this.performanceMetrics.length>50&&this.performanceMetrics.shift()}const i=Math.max(16,Math.min(33,16+t/this.effectiveGameSpeed*16));this.gameLoopId=setTimeout(()=>this.gameLoop(),i)}processTurn(){this.eventSystem.emit(t.TURN_START,{gameState:this.gameState,turn:this.gameState.time.week}),this.advanceTime(),this.processEconomicChanges(),this.processPoliticalChanges(),this.processInternationalRelations(),this.processCrisisManagement(),this.processPolicyEffects(),this.processRandomEvents(),this.calculateDerivedMetrics(),this.updateAIOpposition(),this.eventSystem.processQueue(),this.gameState.time.week%4==0&&this.autoSave(),this.eventSystem.emit(t.TURN_END,{gameState:this.gameState,turn:this.gameState.time.week})}updateGameSystems(){this.eventSystem.emit("game:turn_processed",{gameState:this.gameState,systems:{political:this.politicalEvents.getPoliticalStatus(this.gameState),coalition:this.politicalEvents.getCoalitionStability()}}),this.winConditions.checkWinConditions(this.gameState)}advanceTime(){this.gameState.time.week+=1,this.gameState.time.week>52&&(this.gameState.time.week=1,this.gameState.time.year+=1);const e=new Date(this.gameState.time.startDate),t=52*(this.gameState.time.year-1)+this.gameState.time.week-1;this.gameState.time.currentDate=new Date(e.getTime()+7*t*24*60*60*1e3)}saveGame(e=null){const i=this.saveSystem.saveGame(this.gameState,e);return this.eventSystem.emit(t.GAME_SAVE,{success:i,gameState:this.gameState,saveName:e}),i}loadGame(e){const i=this.saveSystem.loadGame(e);return i?(this.gameState=i,this.eventSystem.emit(t.GAME_LOAD,{success:!0,gameState:this.gameState}),!0):(this.eventSystem.emit(t.GAME_LOAD,{success:!1,saveId:e}),!1)}autoSave(){return this.saveSystem.autoSave(this.gameState)}updateGameState(e){this.gameState=this.mergeDeep(this.gameState,e),this.eventSystem.emit(t.UI_UPDATE,{gameState:this.gameState,updates:e})}handleOppositionDebateResponse(e){const{debateId:t,response:i}=e,s=this.aiOpposition.handleDebateResponse(t,i);s&&s.impact&&s.impact.approval&&this.updateGameState({politics:{...this.gameState.politics,approval:Math.max(0,Math.min(100,this.gameState.politics.approval+s.impact.approval))}})}getGameState(){const e=JSON.parse(JSON.stringify(this.gameState));return e.aiOpposition=this.aiOpposition.getOppositionStatus(),e}resetGameState(e){this.gameState=e,this.eventSystem.emit(t.GAME_START,{gameState:this.gameState}),console.log("Game state reset with new configuration")}getGameStats(){return{isRunning:this.isRunning,isPaused:this.isPaused,gameSpeed:this.gameSpeed,fps:this.fps,currentTurn:this.gameState.time.week,currentYear:this.gameState.time.year,playtime:this.calculatePlaytime(),eventSystemStats:this.eventSystem.getStats(),storageStats:this.saveSystem.getStorageStats()}}setGameSpeed(e){this.gameSpeed=Math.max(100,Math.min(5e3,e)),console.log(`Game speed set to ${this.gameSpeed}ms per turn`)}resetGame(e){this.stop(),p.cleanup(),this.winConditions.resetAchievements(),this.aiOpposition.reset(),this.gameState=e,this.gameLoopId&&(clearTimeout(this.gameLoopId),this.gameLoopId=null),this.frameCount=0,this.lastFrameTime=Date.now(),this.fps=0,this.lastUpdateTime=0,this.eventSystem.emit(t.GAME_START,{gameState:this.gameState}),this.start(),console.log("Game reset complete")}handleGameEnd(e){const{endCondition:t}=e;this.stop(),this.gameState.gameEnded=!0,this.gameState.endCondition=t,this.saveSystem.saveGame(this.gameState,`Final State - ${t.title}`),this.eventSystem.emit("ui:game_end",{endCondition:t,gameState:this.gameState}),console.log(`Game ended: ${t.title}`)}requestReset(e="confirm"){this.eventSystem.emit("game:reset_request",{currentGameState:this.gameState,resetType:e})}createInitialGameState(){const e=new Date;return{version:"1.0.0",player:{name:"Player",party:"Independent",experience:0,skills:{economics:{level:1,experience:0},diplomacy:{level:1,experience:0},communication:{level:1,experience:0},leadership:{level:1,experience:0}}},country:{name:"Democracia",population:5e7,gdp:1e12,debt:6e11,stability:75},economy:{gdpGrowth:2.1,unemployment:6,inflation:2.4,interestRate:3.5,sectors:{agriculture:5,manufacturing:25,services:70}},politics:{approval:50,coalition:[{party:"Government",support:45},{party:"Coalition Partner",support:22}],opposition:[{party:"Main Opposition",support:30},{party:"Minor Opposition",support:3}],nextElection:{year:4,week:1},nextVote:null},global:{relations:{"United Federation":75,"Eastern Empire":60,"Southern Union":80},tradeBalance:15e9,internationalStanding:"Good"},time:{startDate:e.toISOString(),currentDate:e.toISOString(),week:1,year:1},events:{recent:[{id:Date.now(),title:"Game Initialized",description:"Welcome to SP_Sim! You have been elected as the new leader.",type:"system",severity:"neutral",week:1,year:1,timestamp:e.toISOString()}],pending:[]},scandals:{active:[],resolved:[]},achievements:{unlocked:[],progress:{}},gameEnded:!1,endCondition:null}}initializeEventListeners(){this.eventSystem.on(t.POLICY_PROPOSED,e=>{this.gameState.events.pending.push(e.data)}),this.eventSystem.on(t.APPROVAL_CHANGE,e=>{this.gameState.politics.approval=Math.max(0,Math.min(100,e.data.newApproval))}),this.eventSystem.on("economic:update",e=>{const t=e.data;this.gameState.economy={...this.gameState.economy,...t.metrics,sectors:t.sectors,cycle:t.cycle}}),this.eventSystem.on("economic:event",e=>{this.gameState.events.recent.push({type:"economic",...e.data,timestamp:Date.now()}),this.gameState.events.recent.length>10&&(this.gameState.events.recent=this.gameState.events.recent.slice(-10))}),this.eventSystem.on("game:reset",e=>{this.resetGame(e.data.newGameState)}),this.eventSystem.on("game:end",e=>{this.handleGameEnd(e.data)}),this.eventSystem.on("political:vote_scheduled",e=>{}),this.eventSystem.on("policy:implement",e=>{this.handlePolicyImplementation(e.data)}),this.eventSystem.on("achievement:unlocked",e=>{}),this.eventSystem.on("opposition:debate_response",e=>{this.handleOppositionDebateResponse(e.data)})}updateFPS(e){this.frameCount+=1,e-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=e)}calculatePlaytime(){const e=new Date(this.gameState.time.startDate),t=new Date(this.gameState.time.currentDate);return Math.floor((t-e)/6048e5)}handlePolicyImplementation(e){const{policy:i}=e;console.log("Policy implementation requested:",i.name);const s=this.policyImplementationEngine.implementPolicy(i,this.gameState);s.success?(this.gameState.policies||(this.gameState.policies={active:[],completed:[],failed:[]}),this.gameState.policies.active.push(s.implementation),this.gameState.events.recent.push({type:"policy",message:`Started implementing policy: ${i.name}`,timestamp:Date.now(),policy:s.implementation}),this.gameState.events.recent.length>10&&(this.gameState.events.recent=this.gameState.events.recent.slice(-10)),this.eventSystem.emit(t.UI_NOTIFICATION,{message:s.message,type:"success"}),this.eventSystem.emit("policy:implemented",{policy:s.implementation,gameState:this.gameState}),this.monetizationFramework.trackFeatureUsage("policy_implementation",{category:i.category,complexity:i.complexity,tier:this.monetizationFramework.subscriptionTier})):(this.eventSystem.emit(t.UI_NOTIFICATION,{message:s.message,type:"warning"}),this.eventSystem.emit("policy:rejected",{policy:i,reason:s.reason,message:s.message,upgradePrompt:s.upgradePrompt}))}calculatePoliticalCapital(){const{approval:e}=this.gameState.politics,t=this.gameState.politics.coalition?.reduce((e,t)=>e+t.support,0)||0,i=Math.floor(e/2),s=Math.floor(t/2),a=5*(this.gameState.policies?.active?.length||0);return Math.max(0,i+s-a)}mergeDeep(e,t){const i={...e};return Object.keys(t).forEach(e=>{t[e]&&"object"==typeof t[e]&&!Array.isArray(t[e])?i[e]=this.mergeDeep(i[e]||{},t[e]):i[e]=t[e]}),i}processEconomicChanges(){if("basic"===this.simulationDepth.economic)return;const{gameState:e}=this,t={...e.economy},i=this.calculatePolicyEconomicEffects(),s=this.calculateExternalEconomicFactors(),a=this.calculateBusinessCycleEffects(),n=this.calculateMarketConfidence(),o=this.economicSimulation.processEconomicTurn(e,i,s,a,n);e.economy=o,e.economy.deltas={gdpGrowthDelta:e.economy.gdpGrowth-t.gdpGrowth,unemploymentDelta:e.economy.unemployment-t.unemployment,inflationDelta:e.economy.inflation-t.inflation},this.eventSystem.emit("economic:update",{metrics:e.economy,sectors:e.economy.sectors,cycle:e.economy.cycle,changes:e.economy.deltas,confidenceIndex:e.economy.confidence})}processPoliticalChanges(){if("basic"===this.simulationDepth.political)return;const{gameState:e}=this;this.updateApprovalRating(e),this.updateCoalitionDynamics(e),this.checkForPoliticalEvents(e),this.updateParliamentaryDynamics(e),this.checkLeadershipChallenges(e),this.updatePoliticalCapital(e)}processInternationalRelations(){"basic"!==this.simulationDepth.international&&this.eventSystem.emit("turn:end",{data:{gameState:this.gameState}})}processCrisisManagement(){"basic"!==this.simulationDepth.crisis&&this.eventSystem.emit("turn:end",{data:{gameState:this.gameState}})}processPolicyEffects(){this.gameState.policies&&this.gameState.policies.implementing&&this.gameState.policies.implementing.forEach(e=>{e.timeline&&(e.timeline.progress+=1,this.checkPolicyPhaseAdvancement(e),this.applyOngoingPolicyEffects(e))})}processRandomEvents(){let e=.05;this.gameState.economy.gdpGrowth<0&&(e+=.02),this.gameState.politics.approval<40&&(e+=.02),1===this.gameState.time.year&&(e*=.5),Math.random()<e&&this.generateRandomEvent()}calculateDerivedMetrics(){const{gameState:e}=this;e.stability=this.calculateStabilityIndex(e),e.country.governmentEffectiveness=this.calculateGovernmentEffectiveness(e),e.country.internationalStanding=this.calculateInternationalStanding(e),this.updateDemographics(e),e.country.qualityOfLife=this.calculateQualityOfLife(e)}updateAIOpposition(){this.aiOpposition.analyzeGameState(this.gameState),this.aiOpposition.updateStrategy(this.gameState)}calculatePolicyEconomicEffects(){if(!this.gameState.policies||!this.gameState.policies.active)return{};const e={gdpGrowthEffect:0,unemploymentEffect:0,inflationEffect:0,confidenceEffect:0};return this.gameState.policies.active.forEach(t=>{t.economicEffects&&Object.keys(t.economicEffects).forEach(i=>{void 0!==e[i]&&(e[i]+=t.economicEffects[i])})}),e}calculateExternalEconomicFactors(){const e={globalGrowthEffect:0,tradeEffect:0,commodityPriceEffect:0,currencyEffect:0};if(this.internationalRelationsSystem){const{globalEconomy:t}=this.internationalRelationsSystem;e.globalGrowthEffect=.2*(t.growth-2.5);const{tradeAgreements:i}=this.internationalRelationsSystem;e.tradeEffect=.01*i.length,e.commodityPriceEffect=.001*(75-t.oilPrice)}return e}calculateBusinessCycleEffects(){const{cycle:e}=this.economicSimulation,t={gdpEffect:0,unemploymentEffect:0,inflationEffect:0},i=e.intensity||.5;switch(e.phase){case"expansion":t.gdpEffect=.3*i,t.unemploymentEffect=-.2*i,t.inflationEffect=.1*i;break;case"peak":t.gdpEffect=.1*i,t.unemploymentEffect=0,t.inflationEffect=.3*i;break;case"contraction":t.gdpEffect=-.4*i,t.unemploymentEffect=.3*i,t.inflationEffect=-.1*i;break;case"trough":t.gdpEffect=-.1*i,t.unemploymentEffect=.4*i,t.inflationEffect=-.2*i;break;default:t.gdpEffect=0,t.unemploymentEffect=0,t.inflationEffect=0}return t}calculateMarketConfidence(){const{gameState:e}=this;let t=50;return e.economy.gdpGrowth>2&&(t+=10),e.economy.gdpGrowth<0&&(t-=15),e.economy.unemployment<5&&(t+=5),e.economy.unemployment>8&&(t-=10),e.economy.inflation>4&&(t-=8),e.politics.approval>60&&(t+=8),e.politics.approval<40&&(t-=10),this.crisisManagementSystem&&this.crisisManagementSystem.activeCrises&&(t-=.1*this.crisisManagementSystem.activeCrises.reduce((e,t)=>e+t.severity,0)),{level:Math.max(0,Math.min(100,t)),change:t-(e.economy.confidence||50)}}updateApprovalRating(e){const t=e.politics.approval;let i=0;const s=10*(e.economy.deltas?.gdpGrowthDelta||0),a=8*-(e.economy.deltas?.unemploymentDelta||0),n=6*-(e.economy.deltas?.inflationDelta||0);if(i+=.3*s,i+=.4*a,i+=.3*n,1===e.time.year&&(i+=.3*Math.max(0,(52-e.time.week)/52)),this.crisisManagementSystem&&this.crisisManagementSystem.activeCrises){const e=this.crisisManagementSystem.activeCrises.length,t=this.crisisManagementSystem.resolvedCrises.length;i+=.2*(t/(e+t||1)-.5)}this.internationalRelationsSystem&&(i+=(this.calculateAverageRelations(e)-65)/100*.05);const o=.01*(50-t);i+=o,i+=.2*(Math.random()-.5),e.politics.approval=Math.max(0,Math.min(100,t+i)),e.politics.approvalHistory||(e.politics.approvalHistory=[]);const r=.3*s+.4*a+.3*n,c=1===e.time.year?.3*Math.max(0,(52-e.time.week)/52):0,l=this.crisisManagementSystem?.2*(this.crisisManagementSystem.resolvedCrises.length/(this.crisisManagementSystem.activeCrises.length+this.crisisManagementSystem.resolvedCrises.length||1)-.5):0,p=this.internationalRelationsSystem?(this.calculateAverageRelations(e)-65)/100*.05:0;e.politics.approvalHistory.push({week:e.time.week,year:e.time.year,value:e.politics.approval,change:i,factors:{economic:r,honeymoon:c,crisis:l,international:p,regression:o,random:i-(r+c+l+p+o)}}),e.politics.approvalHistory.length>104&&e.politics.approvalHistory.shift(),this.eventSystem.emit("political:approval_change",{change:i,newApproval:e.politics.approval,factors:e.politics.approvalHistory[e.politics.approvalHistory.length-1].factors})}calculateAverageRelations(e){if(!this.internationalRelationsSystem||!this.internationalRelationsSystem.relationships)return 65;const t=Object.values(this.internationalRelationsSystem.relationships);return 0===t.length?65:t.reduce((e,t)=>e+t,0)/t.length}updateCoalitionDynamics(e){if(!e.politics.coalition)return;const{coalition:t}=e.politics;let i=0;e.politics.approval>60&&(i+=.5),e.politics.approval<40&&(i-=1),e.policies&&e.policies.active&&(i-=.3*e.policies.active.filter(e=>e.controversy>60).length),i+=.4*(Math.random()-.5),t.stability=Math.max(0,Math.min(100,t.stability+i)),t.stability<30&&Math.random()<.1&&this.triggerCoalitionCrisis(e)}checkForPoliticalEvents(e){this.politicalSystem.checkForPoliticalEvents(e)}updateParliamentaryDynamics(e){if(!e.politics.parliament)return;const{parliament:t}=e.politics;t.parties&&t.parties.forEach(t=>{if(t.isGoverning){const i=.1*(e.politics.approval-t.support);t.support=Math.max(0,Math.min(100,t.support+i))}else{const i=e.politics.approval<50?.2:-.1;t.support=Math.max(0,Math.min(100,t.support+i))}})}checkLeadershipChallenges(e){let t=0;e.politics.approval<30?t=.05:e.politics.approval<40&&(t=.02),this.crisisManagementSystem&&this.crisisManagementSystem.activeCrises.length>2&&(t+=.02),Math.random()<t&&this.triggerLeadershipChallenge(e)}updatePoliticalCapital(e){e.politics.politicalCapital||(e.politics.politicalCapital=50);let t=0;e.politics.approval>60&&(t+=1),e.politics.approval<40&&(t-=1),this.crisisManagementSystem&&(t+=.5*this.crisisManagementSystem.resolvedCrises.filter(t=>e.time.week-t.resolvedWeek<4).length),t+=.1,e.politics.politicalCapital=Math.max(0,Math.min(100,e.politics.politicalCapital+t))}checkPolicyPhaseAdvancement(e){if(!e.timeline||!e.timeline.phases)return;const t=e.timeline.phases[e.timeline.currentPhase];t&&e.timeline.progress>=t.duration&&(e.timeline.currentPhase+=1,e.timeline.progress=0,this.eventSystem.emit("policy:phase_advanced",{policy:e,newPhase:e.timeline.phases[e.timeline.currentPhase]}),e.timeline.currentPhase>=e.timeline.phases.length&&this.completePolicy(e))}applyOngoingPolicyEffects(e){if(!e.effects||!e.effects.ongoing)return;const t=e.timeline.progress/e.timeline.totalWeeks*.1;Object.keys(e.effects.ongoing).forEach(i=>{const s=e.effects.ongoing[i]*t;this.applyGameStateEffect(i,s)})}generateRandomEvent(){const e=this.weightedRandomSelect([{type:"economic_news",weight:.3},{type:"political_development",weight:.25},{type:"international_incident",weight:.2},{type:"social_issue",weight:.15},{type:"natural_event",weight:.1}]);this.generateEventByType(e)}calculateStabilityIndex(e){let t=50;return t+=Math.max(-10,Math.min(10,3*e.economy.gdpGrowth)),t-=Math.max(0,2*(e.economy.unemployment-6)),t-=Math.max(0,3*(e.economy.inflation-3)),t+=.3*(e.politics.approval-50),this.crisisManagementSystem&&(t-=.1*this.crisisManagementSystem.activeCrises.reduce((e,t)=>e+t.severity,0)),Math.max(0,Math.min(100,t))}calculateGovernmentEffectiveness(e){let t=50;return t+=.3*(e.politics.approval-50),e.politics.politicalCapital&&(t+=.2*(e.politics.politicalCapital-50)),this.crisisManagementSystem&&(t+=.1*(this.crisisManagementSystem.activeCrises.reduce((e,t)=>e+t.managementScore,0)/(this.crisisManagementSystem.activeCrises.length||1)-50)),Math.max(0,Math.min(100,t))}calculateInternationalStanding(e){if(!this.internationalRelationsSystem)return 50;const t=this.calculateAverageRelations(e),i=this.internationalRelationsSystem.tradeAgreements.length,s=Object.values(this.internationalRelationsSystem.organizations).filter(e=>e.membership).reduce((e,t)=>e+t.influence,0)/10;return Math.max(0,Math.min(100,.6*t+2*i+s))}updateDemographics(e){if("basic"===this.simulationDepth.demographics)return;e.demographics||(e.demographics={populationGrowth:.8,ageDistribution:{young:30,middle:50,elderly:20},education:{low:30,medium:50,high:20},income:{low:35,middle:45,high:20}});const t=.1*(e.economy.gdpGrowth-2);e.demographics.populationGrowth+=.1*t,e.economy.gdpGrowth>2&&(e.demographics.education.high+=.01,e.demographics.education.medium-=.005,e.demographics.education.low-=.005)}calculateQualityOfLife(e){let t=50;return t+=Math.max(-15,Math.min(15,5*e.economy.gdpGrowth)),t-=Math.max(0,3*(e.economy.unemployment-5)),t-=Math.max(0,2*(e.economy.inflation-2)),t+=.2*(e.politics.approval-50),t+=.3*(e.stability-50),Math.max(0,Math.min(100,t))}weightedRandomSelect(e){const t=e.reduce((e,t)=>e+t.weight,0);let i=Math.random()*t,s=e[e.length-1].type;return e.some(e=>(i-=e.weight,i<=0&&(s=e.type,!0))),s}generateEventByType(e){this.eventSystem.emit("game:random_event",{type:e,gameState:this.gameState})}applyGameStateEffect(e,t){const i=e.split(".");let s=this.gameState;for(let n=0;n<i.length-1;n++)s[i[n]]||(s[i[n]]={}),s=s[i[n]];const a=i[i.length-1];void 0!==s[a]&&(s[a]+=t)}completePolicy(e){if(this.gameState.policies.implementing){const t=this.gameState.policies.implementing.indexOf(e);t>-1&&this.gameState.policies.implementing.splice(t,1)}this.gameState.policies.active||(this.gameState.policies.active=[]),this.gameState.policies.active.push(e),e.effects&&e.effects.final&&Object.keys(e.effects.final).forEach(t=>{this.applyGameStateEffect(t,e.effects.final[t])}),this.eventSystem.emit("policy:completed",{policy:e})}triggerCoalitionCrisis(e){this.eventSystem.emit("political:coalition_crisis",{gameState:e,severity:100-e.politics.coalition.stability})}triggerLeadershipChallenge(e){this.eventSystem.emit("political:leadership_challenge",{gameState:e,probability:e.politics.approval<30?.6:.3})}})}}});
